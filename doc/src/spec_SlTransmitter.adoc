= SlTransmitter
:Date:      31.01.2017
:Revision:  0.2
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[trans-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального передатчика SL-канала

[[trans-top-level-description]]
== Описание верхнего уровня

[[trans-input-signals]]
=== Входные сигналы

* rst_n - асинхронный общий сигнал сброса
* clk - сигнал тактовой частоты
* [31:0] D_in - порт для записи данных в регистры
* wr_en - После установки в 1 в выбранный портом А регистр записывается необходимое число
* addr - "0" - регистр данных, "1" - регистр конфигурации и состояния

[[trans-output-signals]]
==== Выходные сигналы

* SL0 - сигнал нулей SL канала
* SL1 - сигнал единиц SL канала
* [31:0] D_out - порт для чтения регистров
* irq - вывод прерывания

[[trans-inout-signals]]
=== Двунаправленные сигналы

Отсутствуют.


[[trans-programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

* Регистр конфигурации и состояния (config_r и status_r)
* Данных к отправке (txdata_r)

=== Регистр конфигурации и состояния

Регистр конфигурации и состояния состоит из двух объединеных  регистров -
конфигурации и состояния. Регистру конфигурации соответвуют младшие 16 разрядов, регистру состояния - старшие.

.Назначение разрядов регистра конфигурации  (config_r)
[cols="16*^", width=99%]
|===
|0     |1 |2 |3 |4 |5  |6       |7       |8    |9     |10   |11   |12   |13   |14    |15
|SR  6+|BC[6:0]                 |IRQM  3+|FQM[9:7]          |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра конфигурации (config_r)
. SR - soft reset, включает (SR=1) и выключает (SR=0) приемник
. BC - bit count, количество бит в слове
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля
. FQM - frequency mode, соответствие значения FQM и во сколько раз делится частота описано в таблице ниже.

.Связь значения FQM и частоты работы передатчика
[cols="2*^", width=99%]
|===
|Значение FQM в десятичной системе     | Делитель частоты
|1                                     |2
|2                                     |4
|3                                     |8
|4                                     |16
|5                                     |32
|>5                                    |32
|===

.Назначение разрядов регистра состояния (status_r)
[cols="16*^", width=99%]
|===
|16    |17   |18   |19   |20   |21   |22   |23     |24    |25    |26    |27     |28   |29   |30   |31
|SIP   |Res* |Res* |Res* |Res* |Res* |Res* |Res* 3+|IRQSM |IRQCC |IRQIC |IRQDWE |Res* |Res* |Res* |Res*
|===

.Описание разрядов регистра состояния (status_r)
. SIP - send in process, сообщение отправлется, при попытке перезаписи этого бита ничего не происходит
. IRQSM - interrupt request of sent message
. IRQWCC - interrupt request of wrong configuration changed
. IRQIC - interrupt request of incorrect configuration
. IRQDWE - interrupt request of data write error

=== Регистр данных к отправке
txdata_r[31:0]

.Назначение разрядов регистра данных к отправке (txdata_r)
[cols="1*^", width=99%]
|===
|0 - 31
|Data
|===

Data - данные к отправке.

== Описание работы

Модуль отправляет SL-сообщения. Сообщения могут иметь четную длинну от 8 до 32 бит.
 Бит четности формируется автоматически. Частота импульсов может меняться от 500кГц
 до 16МГц (при частоте тактового сигнала = 16МГц).

.Запись и чтение регистров
Управление модулем осуществляется путем записи/чтения регистров.

Запись в регистры осуществляется подачей записываемой информации на шину d_in,
адреса на порт addr,
и единицы на порт wr_en. В режиме отправки сообщения (поле регистра состояния SIP  = "1")
запись в регистр конфигурации и состояния возможна, но при изменении конфигурационной
части корректность отправляемого сообщения не гарантируется. Попытка записать в конфигурационный регистр некорректные
параметры игнорируется. Попытка записать данные в процессе отправки сообщения игнорируется.

Для чтения регистра необходимо подать адрес на порт addr и считать
информацию с шины d_out.

.Смена конфигурации
Для изменения конфигурации приемника необходимо перезаписать регистр конфигурации и состояния.
В конфигурационной части вы можете установить необходимую частоту, длинну слова, разрешение вызова прерываний, или включить/выключить модуль.

.Отправка сообщений
Для отправки сообщения необходимо записать отправляемое сообщение в регистр данных к отправке.
Сразу после записи модуль переходит в режим отправки сообщения. При этом
поле SIP регистра состояния устанавливается в "1".
В случае когда поле BC регистра конфигурации не равно 32, отправляемым сообщением
являются младшие биты регистра данных. Старшие биты регистра, которые не входят в длинну сообщения
заданную конфигурацией (txdata[31:32-BC]) будут записаны в регистр, но игнорированы при отправке.

.Прерывания
Прерывания вызываются если поле регистра конфигурации IRQM = 1 и произошло одно из событий:
* Отправка сообщения завершена
* Была предпринята попытка записать некорректные данные в конфигурационный регистр
* Изменение конфигурации в процессе отправки сообщения
* Попытка записать новые данные во время отправки старых
Причину возникновения можно посмотреть  в соотвествующих полях регистра состояния.
Для сбрасывания прерываний, вам необходимо считать регистр конфигурации и состояния и
записать считанное снова, занулив биты прерываний.

.Выключение модуля
При выключении передатчика (поле регистра конфигурации SR = "1"), передатчик прекращает отправку текущего сообщения.
 Когда передатчик выключен, запись в регистр данных игнорируется.

[[trans-state-machine]]
== Конечный автомат
image::image_SlTransmitter_SM.png[title="Конечный автомат модуля SlTransmitter", align="center"]
