= SlTransmitter
:Date:      31.01.2017
:Revision:  0.3
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[trans-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального передатчика SL-канала.
Передатчик отправляет SL-сообщения. Сообщения могут содержать информацию четной разрядности от 8 до 32 бит.
Бит четности формируется автоматически. Частота импульсов может меняться от 500кГц.
до 16МГц (при частоте тактового сигнала = 16МГц).

[[sl-channel-review-2]]
== Описание SL-канала
SL - канал - последовательный однонаправленный канал обмена данными, разработанный
для внутриплатного и межплатного обмена информацией. Обмен данными типа "точка-с-точкой".
Канал состоит из двух линий: линии единиц и линии нулей.
Пассивный уровень на линиях - единица.
В случае передачи данных каждый разряд кодируется отрицательным импульсом на соответствующей линии.
Информация передается словами младшими разрядами вперед. Предпоследний разряд - четность.
Передатчик вычисляет четность таким образом,
чтобы количество импульсов на линии единиц с учетом разряда четности было нечетным,
а на линии нулей - четным. Приемник контролирует четность индивидуально по каждой линии.
Последним импульсом является синхроимпульс, представляющий собой отрицательные
импульсы по обоим линиям одновременно. Синхроимпульс означает, что передача закончена.
Не допускается перекрытия информационных импульсов во время передачи.

image::SL.png[title="Временная диаграмма SL-канала", align="center"]

Типичная рабочая частота передатчика, спроектированного в синхронном стиле,
составляет от 500кГц до 1МГц. Пауза между информационными битами равна длительности
 отрицательного импульса.

[[trans-top-level-description]]
== Описание верхнего уровня передатчика

.Порты цифрового модуля SlTransmitter
[cols="5*^", halign="left", width=99%]
|===
|Название    |Разрядность |Тип |Сброс |Описание
|rst_n       |1           |I   | -     |Асинхронный общий сигнал сброса
|clk         |1           |I   | -     |Сигнал тактовой частоты
|D_in        |32          |I   | -     |Данные для записи в регистры
|D_out       |32          |O   |h0     |Данные для чтения регистров
|addr        |1           |I   | -     |Сигнал адреса регистра
|wr_en       |1           |I   | -     |Сигнал разрешения записи
|SL0         |1           |O   |b1     |Сигнал нулей SL канала
|SL1         |1           |O   |b1     |Сигнал единиц SL канала
|irq         |1           |O   |b0     |Сигнал запроса на прерывание
|===

<<<
[[trans-programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

* Регистр конфигурации и состояния (config_r и status_r)
* Данных к отправке (txdata_r)

=== Регистр конфигурации и состояния

Регистр конфигурации и состояния состоит из двух объединенных  регистров -
конфигурации и состояния. Регистру конфигурации соответствуют младшие 16 разрядов,
регистру состояния - старшие.

.Назначение разрядов регистра конфигурации  (config_r)
[cols="17*^", width=99%]
|===
|Bit     |15   |14  |13 |12 |11 |10 |9  |8  |7  |6 |5 |4 |3 |2 |1 |0
|Name    |-    |- 4+|IRQM[3:0]    3+|FQM[2:0] 6+|BC[6:0]          |SR
|Mode    |R    |R 4+|R/W          3+|R/W      6+|R/W              |R/W
|Initial |0    |0   |0  |0  |0  |0  |0  |0  |0  |0 |0 |1 |0 |0 |0 |0
|===

.Описание разрядов регистра конфигурации (config_r)
. SR - soft reset, включает (SR=1) и выключает (SR=0) приемник
. BC - bit count, количество бит данных в отправляемом сообщении
. IRQM - interrupt request mask, задает, какие именно биты причин прерываний вызывают запрос прерывания
. FQM - frequency mode, соответствие значения FQM и делителя частоты описано в таблице ниже.

.Связь разрядов IRQM и маскирования причин прерываний
[cols="2*^", width=99%]
|===
|Разряд поля IRQM     |Маскируемый бит
|IRQM0                |IRQSM
|IRQM1                |IRQWCC
|IRQM2                |IRQICC
|IRQM3                |IRQDWE
|===

.Связь значения поля FQM и частоты работы передатчика
[cols="4*^", width=99%]
|===
|FQM2 |FQM1 | FQM0   | Делитель частоты
|0    |0    |0       |32
|0    |0    |1       |2
|0    |1    |0       |4
|0    |1    |1       |8
|1    |0    |0       |16
|1    |0    |1       |32
|1    |1    |0       |32
|1    |1    |1       |32
|===




.Назначение разрядов регистра состояния (status_r)
[cols="17*^", width=99%]
|===
|Bit     |31 |30 |29 |28 |27     |26    |25    |24    |23 |22 |21 |20 |19 |18 |17 |16
|Name    |-  |-  |-  |-  |IRQDWE |IRQIC |IRQCC |IRQSM |-  |-  |-  |-  |-  |-  |-  |SIP
|Mode    |R  |R  |R  |R  |R/W0   |R/W0  |R/W0  |R/W0  |R  |R  |R  |R  |R  |R  |R  |R
|Initial |0  |0  |0  |0  |0      |0     |0     |0     |0  |0  |0  |0  |0  |0  |0  |0
|===

.Описание разрядов регистра состояния (status_r)
. SIP - send in process, сообщение отправляется, при попытке перезаписи этого бита ничего не происходит
. IRQSM - interrupt request of sent message, запрос прерывания успешно отправленного сообщения
. IRQWCC - interrupt request of wrong configuration change, запрос прерывания попытки сменить конфигурацию во время отправки сообщения
. IRQICC - interrupt request of incorrect configuration change, запрос прерывания попытки установить неверную конфигурацию
. IRQDWE - interrupt request of data write error, запрос прерывания попытки записать сообщение во время отправки предыдущего

=== Регистр данных к отправке
txdata_r[31:0]

.Назначение разрядов регистра данных к отправке (txdata_r)
[cols="2*^", width=99%]
|===
|Bit     |31 - 0
|Name    |Data
|Mode    |R/W
|Initial |0
|===
.Описание разрядов регистра  данных к отправке (txdata_r)
. Data - данные к отправке.

<<<
== Работа с программной моделью

=== Запись и чтение регистров
Управление модулем осуществляется путем записи/чтения регистров.

Для считывания текущего значения одного из регистров блока необходимо сформировать на шине addr соответствующее ему значение,
указанное в таблице, длительностью не меньше такта опорной тактовой частоты.
Значение регистра будет сформировано на шине d_out через такт опорной после фронта сигнала на шине addr.

Для записи значения в один из регистров блока необходимо сформировать:

* на шине addr значение соответствующее регистру
* на шине d_in записываемую информацию,
* на порт wr_en - значение 1.

Также на на шине d_out через такт опорной после фронта сигнала на шине addr будет сформировано значение записанного регистра.
Значение шины d_out будет соответствовать значению последнего опрошенного или записанного регистра до формирования следующего запроса.

.Адреса регистров
[cols="2*^", width=99%]
|===
|Значение шины addr | Выбранный регистр
|1'b0               | регистр данных (txdata_r)
|1'b1               | регистр конфигурации и состояния (config_r и status_r)
|===

Запись в регистр данных во время отправки сообщения, приведет к прекращению отправки и формированию прерывания.

=== Отправка сообщений

Для отправки сообщений необходимо:

1. Если это необходимо, записать в регистр config_r необходимые настройки частоты и длинны слова (см. раздел "Смена конфигурации")
2. Записать в регистр данных сообщение на отправку
3. Если вы работаете по прерываниям, дождаться запроса на прерывания вызванного оправкой сообщения (IRQSM == 1).
3. Если вы работаете по таймеру, периодически опрашивая регистр состояния, убедится, что сообщение было отправлено (IRQSM == 1).
4. Сбросить поле причины прерывания IRQSM.
5. Записать в регистр данных следующее сообщение.

Сразу после записи в регистр данных модуль переходит в режим отправки сообщения. При этом
поле SIP регистра состояния устанавливается в "1".

В случае когда поле BC регистра конфигурации не равно 32, отправляемым сообщением
являются младшие биты регистра данных. Старшие биты регистра, которые не входят в длину сообщения,
заданную полем BC регистра config_r (txdata_r [31:32-BC]), будут записаны в регистр, но игнорированы при отправке.

Во время отправки сообщения нельзя записывать новое сообщение - отправка будет прервана.

В конце отправки будет выставлен бит IRQSM = 1, и бит SIP = 0.
Если бит IRQSM не замаскирован, возникнет запрос на прерывание.

Для отправки следующего сообщения нужно сбросить поле причины прерывания IRQSM
и записать новое сообщение для отправки.

=== Смена конфигурации

Для изменения конфигурации передатчика необходимо:

1. Считав регистр конфигурации и состояния убедится, что модуль не занят отправкой сообщения ( бит SIP регистра конфигурации и состояния равен 0).
   Если он занят отправкой, дождаться, пока отправка будет завершена.
2. Записать новые параметры в регистр конфигурации и состояния.

Для изменения конфигурации передатчика необходимо перезаписать регистр конфигурации и состояния.
В конфигурационной части может быть установлена необходимая частота, длинна слова,
маскировка причин запроса прерывания или осуществлен сброс модуля к исходным настройкам.
Неверной считается конфигурация с нечетными длинами слова или длинной слова лежащей вне промежутка от 8 до 32 бит.

Нельзя изменять поля BC и FQM во время отправки сообщения - отправка будет прервана.

=== Работа с прерываниями

Запрос прерывания происходит, когда произошло одно из событий и бит этого события не замаскирован :

* Отправка сообщения завершена (IRQSM)
* Была предпринята попытка записать некорректные данные в конфигурационный регистр (IRQICC)
* Изменение конфигурации в процессе отправки сообщения (IRQWCC)
* Попытка записать новые данные во время отправки старых (IRQDWE)

Причину возникновения можно посмотреть  в соответствующих полях регистра состояния.

Для сброса прерывания необходимо записать 0 в биты причин прерываний, которые необходимо сбросить.

Более подробно работа прерываний рассмотрена в разделе Алгоритм работы.

=== Выключение модуля

Чтобы выключить модуль необходимо записать 1 в бит SR регистра конфигурации и состояния.

Если сделать это во время отправки сообщения, отправка прекращается.
Регистры конфигурации и состояния возвращаются в начальное состояние.
Когда передатчик выключен, запись в регистр данных игнорируется.

<<<
[[trans-work-principle]]
== Принцип работы

Отправка сообщения обеспечивается двумя счетчиками: - счетчиком бит и  счетчиком циклов.

Счетчик циклов обеспечивает деление частоты. каждый раз,
когда счетчик циклов оказывается равным нулю, переключается счетчик битов.

На нечетных значениях счетчика бит на выходы SL0 и SL1 подаются значения соответствующие
информационным битам, потом биту четности и синхроимпульсу.

На четных значениях счетчика бит на выходы SL0 и SL1 подаются единицы.

[[trans-work-algorythm]]
== Алгоритм работы
=== Алгоритм работы статусного регистра

В устройстве используются следующие вспомогательный сигналы:

.Внутренние вспомогательные сигналы:
* wire end_of_msg - сигнал конца сообщения
* wire new_config_is_correct - поле BC шины D_in имеет верное значение
* reg shift_r - сдвиговый регистр с отправляемым сообщением
* reg par0, reg par1 - регистры подсчета четности
* reg bit_i - счетчик количества бит
* reg fq_i - счетчик делителя частоты
* wire no_error - наличие ошибки в управлении регистром (смена конфигурации или запись в регистр данных во время отправки)


image::image_SlTransmitter_irq_algorithm.png[title="Алгоритм работы регистра состояния модуля SlTransmitter", align="center"]

Модуль может находиться в двух режимах: режим отправки и режим ожидания. После включения модуля, все биты регистра состояния устанавливаются в 0, модуль
находится в режиме ожидания.

.Смена конфигурации и сброс прерываний в режиме ожидания

При записи регистра конфигурации и состояния в  режиме ожидания происходит проверка
битов прерываний:

1. Если значения полей причин прерываний шины D_in равны 0, то соответствующие поля причин прерываний регистра status_r сбрасываются.
2. В соответствии с битами IRQM шины D_in обновляется поле IRQM регистра config_r
2. После этого если поле BC шины D_in нечетное или не лежит в интервале от 6'd8 до 6'd32, выставляется IRQICС = 1,
поля BC и FQM не изменяются. Если бит IRQICC не замаскирован
формируется запрос на прерывание.
3. Если конфигурация корректна поля BC и FQM шины D_in записывается в регистр config_r.
Модуль остается в режиме ожидания.

.Отправка сообщения

Сразу после записи данных в режиме ожидания, модуль переходит в режим отправки,
устанавливается поле регистра status_r SIP = 1. По успешному окончанию отправки сообщения,
устанавливаются поля регистра status_r SIP = 0 и IRQSM = 1.
Если бит IRQSM не замаскирован формируется запрос на прерывание.

.Попытка отправить сообщение во время отправки предыдущего

Если записать данные в режиме отправки, выставляется бит IRQDWE = 1,
модуль экстренно завершает отправку и возвращается в режим ожидания, выставляется биты SIP = 0.
Если бит IRQDWE не замаскирован формируется запрос на прерывание.

.Изменение конфигурации и сброс прерываний во время отправки сообщения

Когда модуль находится в режиме отправки, то без отмены приема возможно только изменение полей маскирования прерываний, и сброс битов причин прерываний.

Если в режиме отправки происходит запись регистра конфигурации и состояния,
сначала проверяются биты прерываний:если значения полей причин прерываний шины D_in равны 0,
то соотвестующие поля причин прерываний регистра состояния сбрасываются.

После этого, проверяется изменяются
ли биты конфигурации (поля FQM, BC). Если они не изменяются, модуль остается
в режиме отправки сообщения. Если они изменяются то отправка завершается, выставляются
биты SIP = 0 и IRQWCC = 1. Если бит IRQDWСС не замаскирован формируется запрос на прерывание.

Если конфигурация корректна, она записывается в регистр,
если же нет, выставляется бит IRQICC = 1.
Модуль переходит в режим ожидания.

.Формирование запроса на прерывание

Запрос на прерывание формируется на выходе irq, через один такт после возникновения причины прерывания,
 если причина этого прерывания не замаскирована в поле IRQM.

=== Алгоритм отправки сообщения

image::image_SlTransmitter_send_algorithm.png[title="Алгоритм работы модуля SlTransmitter в режиме отправки", align="center"]

В начале режима отправки в сдвиговый регистр загружается отправляемое сообщение.
 Для организации отправки используются два счетчика:

.Счетчик частоты

Счетчик частоты считает от значения (делитель частоты - 1) до значения 0. Когда счетчик частоты достигает максимального значения,
 инкрементируется счетчик количества бит.

.Счетчик количества бит

Счетчик импульсов считает от числа, равного (BC + 2)*2-1 до 0, где BC (bit count) - поле регистра конфигурации.
Число (BC + 2)*2-1 получено следующим образом: необходимо отправить число бит информации заданное полем BC, бит четности и бит синхроимпульса.
В сумме BC+2 бит. Между битами нужно выставить на выход промежуточную комбинацию,
таким образом значение удваивается и получается (BC+2)*2 итераций счетчика и максимальное значение равное (BC+2)*2-1.

.Подсчет четности

Подсчет четности осуществляется при помощи регистров par0 и par1.
Регистр par0 имеет начальное значение 1, и инвертируется каждый раз при отравки информационного бита со значением 0.
Регистр par1 имеет начальное значение 0, и инвертируется каждый раз при отравки информационного бита со значением 1.

Таким образом, если единиц в в отправляемом сообщении будет четное число,
то par1 и par0 изменятся четное количество раз и после отправки всех информационных бит получаем
par0 = 1, par1 = 0. подав эти значения на выходы SL0 и SL1 получим отрицательный импульс на линии единиц,
общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.

Если же единиц в в отправляемом сообщении будет четное число,
то par1 и par0 изменятся нечетное количество раз и после отправки всех информационных бит получаем
par0 = 0, par1 = 1. подав эти значения на выходы SL0 и SL1 получим отрицательный импульс на линии нулей,
общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.  


.Соответствие значения счетчика количества бит и значений на выходах SL0 и SL1

На значениях счетчика битов (BC+2)*2-1, (BC+2)*2-3 .. 7, 5 на выход выставляется комбинация соответствующая первому биту сдвигового регистра.
Также происходит подсчет четности на основе первого бита сдвигового регистра и сдвиг регистра. Таким образом формируются информационные биты.

На всех четных значениях (BC+1)*2, (BC+1)*2 -2, .. 2, 0  на выход выставляется комбинация соответствующая промежутку между значащими битами (единица на линии нулей и единица на линии единиц)

На значении счетчика битов 3 на выход выставляется комбинация соответствующая подсчитанный четности, а на значении 1 - комбинация стоп бита.

.Экстренное завершение отправки

Также на каждом значении счетчика частоты происходит проверка наличия ошибок - попытки записать данные во время отправки или изменения конфигурации. В случае, если ошибка произошла, отправка прекращается.

<<<
