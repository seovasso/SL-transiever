= Спецификация модуля передатчика SL-канала : *SlTransmitter*
//===========
// Compile:
// evgeniy@N7-63:~/Documents/2015VV024/doc$ asciidoctor-pdf -a pdf-style=/home/evgeniy/Documents/RISC-V/fizika-theme.yml -a pdf-fontsdir=/home/evgeniy/Downloads/fonts/Combo/ ./src/2015VV024_datasheet.adoc && mv ./src/2015VV024_datasheet.pdf ./ && evince ./2015VV024_datasheet.pdf
:Authors: Василий Мочалов
:Email:   1@mail.ru
:Date:      31.01.2017
:Revision:  0.3
:toc:       right
:toclevels: 3
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/
:sectnums:
:sectnumlevels: 3
:revnumber: 1.1
:revdate:   15.12.2017
:revremark: Рабочая версия

[[trans-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального передатчика SL-канала. Передатчик отправляет SL-сообщения. Сообщения могут содержать информацию четной разрядности от 8 до 32 бит. Бит четности формируется автоматически. Частота импульсов может меняться от 500кГц до 16МГц (при частоте тактового сигнала = 16МГц).

[[sl-channel-review-2]]
== Описание SL-канала
SL - канал - последовательный однонаправленный канал обмена данными, разработанный для внутриплатного и межплатного обмена информацией. Обмен данными типа "точка-с-точкой". Канал состоит из двух линий: линии единиц и линии нулей. Пассивный уровень на линиях - единица. В случае передачи данных каждый разряд кодируется отрицательным импульсом на соответствующей линии. Информация передается словами младшими разрядами вперед. Предпоследний разряд - четность. Передатчик вычисляет четность таким образом, чтобы количество импульсов на линии единиц с учетом разряда четности было нечетным, а на линии нулей - четным. Приемник контролирует четность индивидуально по каждой линии. Последним импульсом является синхроимпульс, представляющий собой отрицательные импульсы по обоим линиям одновременно. Синхроимпульс означает, что передача закончена. Не допускается перекрытия информационных импульсов во время передачи.

image::SL.png[title="Временная диаграмма SL-канала", align="center"]

Типичная рабочая частота передатчика, спроектированного в синхронном стиле, составляет от 500кГц до 1МГц. Пауза между информационными битами равна длительности отрицательного импульса.

[[trans-top-level-description]]
== Описание верхнего уровня передатчика

.Порты цифрового модуля SlTransmitter
[cols="5*^", halign="left", width=99%]
|===
|Название      |Тип   |Разрядность |Значение после сброса |Описание
|_rst_n_       |In    |1           | -                    |Асинхронный общий сигнал сброса
|_clk_         |In    |1           | -                    |Сигнал тактовой частоты
|_D_in_        |In    |32          | -                    |Данные для записи в регистры
|_addr_        |In    |1           | -                    |Сигнал выбора регистра
|_wr_en_       |In    |1           | -                    |Сигнал разрешения записи
|_D_out_       |Out   |32          |h0000_0000            |Данные для чтения регистров
|_SL0_         |Out   |1           |b1                    |Сигнал нулей SL канала
|_SL1_         |Out   |1           |b1                    |Сигнал единиц SL канала
|_irq_         |Out   |1           |b0                    |Сигнал запроса на прерывание
|===

<<<

[[trans-programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

* Служебный (*config_status_r*)
* Данных к отправке (*txdata_r*)

=== Служебный регистр

Регистр служебный регистр состоит из двух частей - конфигурации и состояния. Части отвечающей за конфигурацию соответствуют младшие 16 разрядов, части состояния старшие.

[[tr_conf_table]]
.Назначение разрядов конфигурационной части служебного регистра (*config_status_r [15:0]*)
[cols="17*^", width=99%]
|===
|Bit        |15   |14  |  13 |12 |11 |10 |9  |8  |7    |6 |5 |4 |3 |2 |1   |0
|Name       |-    |- 4+|*IRQM[3:0]*    3+|*FQM[2:0]* 6+|*BC[6:0]*          |*SR*
|Mode       |R    |R 4+|R/W            3+|R/W        6+|R/W                |R/W
|Initial    |0    |0   |0  |0  |0  |0    |0  |0  |0    |0 |0 |1 |0 |0 |0   |0
|===

.Описание разрядов регистра конфигурационной части служебного регистра (*config_status_r [15:0]*)
. *SR* (soft reset) -- включает (SR = 0) и выключает (SR = 1) приемник
. *BC* (bit count) -- количество разрядов данных в отправляемом сообщении
. *IRQM* (interrupt request mask) -- маска разрядов причин прерываний.
  Задает, какие именно разряды причин прерываний вызывают запрос на прерывание. Описание разрядов причин прерываний можно посмотреть в <<trans_IRQM_table,таблице назначения разрядов части состояния служебного регистра>>. Сотвествие разрядов поля IRQM и разрядов причин прерываний можно посмотреть в соотвествующей <<trans_IRQM_table, таблице>>. *FQM* (frequency mode) -- соответствие значения FQM и делителя частоты описано в <<trans_FQM_table, таблице>> ниже.

[[trans_FQM_table]]
.Соотвествие значения поля *FQM [2:0]* и делителя частоты работы передатчика
[cols="4*^", width=99%]
|===
|FQM2 |FQM1 | FQM0   | Делитель частоты
|0    |0    |1       |2
|0    |1    |0       |4
|0    |1    |1       |8
|1    |0    |0       |16
|0    |0    |0       |32
|1    |0    |1       |32
|1    |1    |0       |32
|1    |1    |1       |32
|===

[[trans_status_part_table]]
.Назначение разрядов части состояния служебного регистра (*config_status_r [31:16]*)
[cols="17*^", width=99%]
|===
|Bit     |31 |30 |29 |28 |27       |26      |25      |24      |23 |22 |21 |20 |19 |18 |17 |16
|Name    |-  |-  |-  |-  |*IRQDWE* |*IRQIC* |*IRQCC* |*IRQSM* |-  |-  |-  |-  |-  |-  |-  |*SIP*
|Mode    |R  |R  |R  |R  |R/W0     |R/W0    |R/W0    |R/W0    |R  |R  |R  |R  |R  |R  |R  |R
|Initial |0  |0  |0  |0  |0        |0       |0       |0       |0  |0  |0  |0  |0  |0  |0  |0
|===

.Описание разрядов части состояния служебного регистра (*config_status_r [31:16]*)
. *SIP* (send in process) -- разряд идещего процесса отправки сообщения
. *IRQSM* (interrupt request of sent message) -- разряд успешно отправленного сообщения
. *IRQWCC* (interrupt request of wrong configuration change) --  прозошла попытка сменить конфигурацию во время отправки сообщения
. *IRQICC* (interrupt request of incorrect  configuration change ) -- произошла попытка установить неверную конфигурацию
. *IRQDWE* (interrupt request of data write error) -- произошла попытка записать сообщение во время отправки предыдущего

[[trans_IRQM_table]]
.Соотвествие разрядов <<tr_conf_table,*IRQM [3:0]*>> и маскирования разрядов причин прерываний
[cols="2*^", width=99%]
|===
|Разряд поля *IRQM*                       |Маскируемый разряд
|*IRQM0*                                  |*IRQSM*
|*IRQM1*                                  |*IRQWCC*
|*IRQM2*                                  |*IRQICC*
|*IRQM3*                                  |*IRQDWE*
|===

=== Регистр данных к отправке
*txdata_r[31:0]*

.Назначение разрядов регистра данных к отправке (*txdata_r*)
[cols="2*^", width=99%]
|===
|Bit     |31 - 0
|Name    |*DATA*
|Mode    |R/W
|Initial |0
|===
.Описание разрядов регистра  данных к отправке (*txdata_r*)
*DATA* - данные к отправке.

<<<

== Работа с программной моделью

=== Запись и чтение регистров
Управление модулем осуществляется путем записи или чтения регистров.

Для считывания текущего значения одного из регистров блока необходимо последовательный на порт _addr_ адрес регистра, указанный в <<trans_addr_table, таблице>>, длительностью не меньше такта опорной тактовой частоты _clk_. Значение регистра будет сформировано на шине _D_out_ через такт опорной частоты после фронта сигнала на шине _addr_.

Для записи значения в один из регистров блока необходимо сформировать:

* на порт _addr_ -- адрес регистра
* на шине _D_in_ -- записываемую информацию,
* на порт _wr_en_ -- значение 1.

Также на на шине d_out через такт опорной частоты _clk_ после фронта сигнала на шине _addr_ будет сформировано значение записанного регистра. Значение шины d_out будет соответствовать значению последнего опрошенного или записанного регистра до формирования следующего запроса.

image::image_SlTransmitter_read_write_waveform.png[title="Временная диаграмма чтения и записи регистров модуля SlTransmitter", align="center"]

[[trans_addr_table]]
.Адреса регистров
[cols="2*^", width=99%]
|===
|Значение сигнала _addr_ | Выбранный регистр
|1'b0                    | регистр данных (txdata_r)
|1'b1                    | служебный регистр (config_status_r)
|===

Запись в регистр данных во время отправки сообщения, приведет к прекращению отправки и формированию прерывания.

=== Отправка сообщений

Для отправки сообщений необходимо:

. Записать в регистр *config_r* необходимые настройки частоты и длины слова (см. раздел "<<trans_config_change, Смена конфигурации>>")
. Записать в регистр данных сообщение на отправку
. Дождавшись запроса на прерывания вызванного отправкой сообщения, или, работая по таймеру и периодически опрашивая регистр состояния, убедится, что сообщение было отправлено  (*IRQSM* == 1).
. Сбросить поле причины прерывания *IRQSM*. Это необходимо для того, чтобы узнать, когда закончится следующая отправка сообщения.
. Записать в регистр данных следующее сообщение.

Сразу после записи в регистр данных модуль переходит в режим отправки сообщения. При этом поле *SIP* регистра состояния устанавливается в "1".

В случае когда поле BC служебного регистра не равно 32, отправляемым сообщением являются младшие биты регистра данных. Старшие разряды регистра, которые не входят в длину сообщения, заданную полем *BC* регистра *config_r* (*txdata_r [31:32-BC]*), будут записаны в регистр, но игнорированы при отправке.

Во время отправки сообщения нельзя записывать новое сообщение - отправка будет прервана, модуль вернется в режим ожидания нового сообщения.

Если отправка не была прервана попыткой изменения конфигурации или записью следующего сообщения, в конце отправки будет выставлен бит *IRQSM* = 1, и бит *SIP* = 0. Если бит *IRQSM* не замаскирован (см. таблицу описания поля <<trans_IRQM_table,IRQM>>), возникнет запрос на прерывание.


[[trans_config_change]]
=== Смена конфигурации

Для изменения конфигурации передатчика необходимо:

1. Считав служебный регистр убедится, что разряд SIP равен 0. Нельзя изменять поля BC и FQM во время отправки сообщения - отправка будет прервана.
2. Записать новые параметры в служебный регистр.

В конфигурационной части служебного регистра может быть установлена необходимая частота, длина слова, маскировка причин запроса прерывания или осуществлен сброс модуля к исходным настройкам.

Неверной считается конфигурация с нечетными длинами слова или длиной слова лежащей вне промежутка от 8 до 32 бит. При попытке записать подобную конфигурацию



=== Работа с прерываниями

Запрос прерывания происходит, когда произошло одно из событий и разряд причины прерываний соотвествующий этому событию не замаскирован:

* *IRQSM* -- Отправка сообщения завершена
* *IRQICC* -- Была предпринята попытка записать неверную конфигурацию в конфигурационный регистр
* *IRQWCC* -- Изменение конфигурации в процессе отправки сообщения
* *IRQDWE* -- Попытка записать новые данные во время отправки сообщения

Узнать какое именно событие вызвало запрос на прерывание можно в <<trans_status_part_table,полях причин прерываний>> служебного регистра.

Для сброса прерывания необходимо записать 0 в разряды причин прерываний, которые необходимо сбросить.

Более подробно работа прерываний рассмотрена в разделе <<trans-work-algorythm, Алгоритм работы>>.

=== Выключение модуля

Чтобы выключить модуль необходимо записать 1 в бит SR служебного регистра.

Если сделать это во время отправки сообщения, отправка прекращается. Служебный регистр возвращаются в начальное состояние, регистр данных сбрасывается. На выходах _SL0_ и _SL1_ устанавливается 1. Когда передатчик выключен, запись в регистр данных игнорируется.

<<<

[[trans-work-principle]]
== Принцип работы

Отправка сообщения обеспечивается двумя счетчиками: - счетчиком бит и  счетчиком циклов.

Счетчик циклов обеспечивает деление частоты. каждый раз, когда счетчик циклов оказывается равным нулю, переключается счетчик битов.

На нечетных значениях счетчика бит на выходы _SL0_ и _SL1_ подаются значения соответствующие информационным битам, потом биту четности и синхроимпульсу.

На четных значениях счетчика бит на выходы _SL0_ и _SL1_ подаются единицы.

[[trans-work-algorythm]]
== Алгоритм работы

В устройстве используются следующие вспомогательный сигналы:

.Внутренние вспомогательные сигналы:
* wire end_of_msg - сигнал конца сообщения
* wire new_config_is_correct - поле BC шины _D_in_ имеет верное значение
* reg shift_r - сдвиговый регистр с отправляемым сообщением
* reg par0, reg par1 - регистры подсчета четности
* reg bit_i - счетчик количества бит
* reg fq_i - счетчик делителя частоты
* wire no_error - наличие ошибки в управлении регистром (смена конфигурации или запись в регистр данных во время отправки)
image::image_SlTransmitter_irq_algorithm.png[title="Алгоритм работы служебного регистра модуля SlTransmitter", align="center"]

Модуль может находиться в двух режимах: режим отправки и режим ожидания. После включения модуля, все биты части состояния служебного регистра устанавливаются в 0, модуль находится в режиме ожидания.

=== Смена конфигурации и сброс прерываний в режиме ожидания

При записи служебного регистра в  режиме ожидания происходит проверка битов прерываний:

1. Если значения полей причин прерываний шины _D_in_ равны 0, то соответствующие поля причин прерываний регистра status_r сбрасываются.
2. В соответствии с битами *IRQM* шины _D_in_ обновляется поле *IRQM* регистра config_r
3. После этого если поле *BC* шины _D_in_ нечетное или не лежит в интервале от 6'd8 до 6'd32, выставляется *IRQICС* = 1, поля *BC* и *FQM* не изменяются. Если бит *IRQICC* не замаскирован формируется запрос на прерывание.
4. Если конфигурация корректна поля *BC* и *FQM* шины _D_in_ записывается в регистр config_r. Модуль остается в режиме ожидания.

=== Отправка сообщения

Сразу после записи данных в режиме ожидания, модуль переходит в режим отправки, устанавливается поле регистра status_r SIP = 1. По успешному окончанию отправки сообщения, устанавливаются поля регистра status_r *SIP* = 0 и *IRQSM* = 1. Если бит *IRQSM* не замаскирован формируется запрос на прерывание.

=== Попытка отправить сообщение во время отправки предыдущего

Если записать данные в режиме отправки, выставляется бит *IRQDWE* = 1, модуль экстренно завершает отправку и возвращается в режим ожидания, выставляется биты *SIP* = 0. Если бит *IRQDWE* не замаскирован формируется запрос на прерывание.

=== Изменение конфигурации и сброс прерываний во время отправки сообщения

Когда модуль находится в режиме отправки, то без отмены приема возможно только изменение полей маскирования прерываний, и сброс битов причин прерываний.

Если в режиме отправки происходит запись служебного регистра, сначала проверяются биты прерываний:если значения полей причин прерываний шины _D_in_ равны 0, то соответствующие поля причин прерываний служебного регистра сбрасываются.

После этого, проверяется изменяются ли биты конфигурации (поля *FQM*, *BC*). Если они не изменяются, модуль остается в режиме отправки сообщения. Если они изменяются то отправка завершается, выставляются биты *SIP* = 0 и *IRQWCC* = 1. Если бит *IRQDWСС* не замаскирован формируется запрос на прерывание.

Если конфигурация корректна, она записывается в регистр, если же нет, выставляется бит *IRQICC* = 1. Модуль переходит в режим ожидания.

=== Формирование запроса на прерывание

Запрос на прерывание формируется на выходе _irq_, через один такт после возникновения причины прерывания, если причина этого прерывания не замаскирована в поле *IRQM*.

image::image_SlTransmitter_send_algorithm.png[title="Алгоритм работы модуля SlTransmitter в режиме отправки", align="center"]

В начале режима отправки в сдвиговый регистр загружается отправляемое сообщение. Для организации отправки используются два счетчика:

=== Счетчик частоты

Счетчик частоты считает от значения (делитель частоты - 1) до значения 0. Когда счетчик частоты достигает максимального значения, инкрементируется счетчик количества бит.

=== Счетчик количества бит

Счетчик импульсов считает от числа, равного (BC + 2)&#42;2-1 до 0, где BC (bit count) - поле служебного регистра. Число (BC + 2)&#42;2-1 получено следующим образом: необходимо отправить число бит информации заданное полем BC, бит четности и бит синхроимпульса. В сумме BC+2 бит. Между битами нужно выставить на выход промежуточную комбинацию, таким образом значение удваивается и получается (BC+2)&#42;2 итераций счетчика и максимальное значение равное (BC+2)&#42;2-1.

=== Соответствие значения счетчика количества бит и значений на выходах SL0 и SL1

На значениях счетчика битов (BC+2)&#42;2-1, (BC+2)&#42;2-3 .. 7, 5 на выход выставляется комбинация соответствующая первому биту сдвигового регистра. Также происходит подсчет четности на основе первого бита сдвигового регистра и сдвиг регистра. Таким образом формируются информационные биты.

На всех четных значениях (BC+1)&#42;2, (BC+1)&#42;2 -2, .. 2, 0  на выход выставляется комбинация соответствующая промежутку между значащими битами (единица на линии нулей и единица на линии единиц)

На значении счетчика битов 3 на выход выставляется комбинация соответствующая подсчитанный четности, а на значении 1 - комбинация стоп бита.

=== Подсчет четности

Подсчет четности осуществляется при помощи регистров par0 и par1. Регистр par0 имеет начальное значение 1, и инвертируется каждый раз при отравки информационного бита со значением 0.
Регистр par1 имеет начальное значение 0, и инвертируется каждый раз при отравки информационного бита со значением 1.

Таким образом, если единиц в в отправляемом сообщении будет четное число, то par1 и par0 изменятся четное количество раз и после отправки всех информационных бит получаем par0 = 1, par1 = 0. подав эти значения на выходы _SL0_ и _SL1_ получим отрицательный импульс на линии единиц, общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.

Если же единиц в в отправляемом сообщении будет четное число, то par1 и par0 изменятся нечетное количество раз и после отправки всех информационных бит получаем par0 = 0, par1 = 1. подав эти значения на выходы _SL0_ и _SL1_ получим отрицательный импульс на линии нулей, общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.

=== Экстренное завершение отправки

Также на каждом значении счетчика частоты происходит проверка наличия ошибок - попытки записать данные во время отправки или изменения конфигурации. В случае, если ошибка произошла, отправка прекращается.
