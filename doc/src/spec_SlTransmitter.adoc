= SlTransmitter
:Date:      31.01.2017
:Revision:  0.2
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[trans-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального передатчика SL-канала

[[sl-channel-review]]
== Описание SL-канала
SL - канал - последовательный однонаправленный канал обмена данными, разработанный для внутриплатного и межплатного обмена информацией. Обмен данными типа "точка-с-точкой". Канал состоит из двух линий: линии единиц и линии нулей. Пассивный уровень на линиях - единица. В случае передачи данных каждый разряд кодируется отрицательным импульсом на соответствующей линии. Информация передается словами младшими разрядами вперед. Предпоследний разряд - четность. Передатчик вычисляет четность таким образом, чтобы количество импульсов на линии единиц с учетом разряда четности было нечетным, а на линии нулей - четным. Приемник контролирует четность индивидуально по каждой линии. Последним импульсом является синхроимпульс, представляющий собой отрицательные импульсы по обоим линиям одновременно. Синхроимпульс означает, что передача закончена. Не допускается перекрытия информационных импульсов во время передачи.

image::SL.png[title="Временная диаграмма SL-канала", align="center"]

Типичная рабочая частота передатчика, спроектированного в синхронном стиле,
составляет от 500кГц до 1МГц. Пауза между информационными битами равна длительности
 отрицательного импульса.

[[trans-top-level-description]]
== Описание верхнего уровня

[[trans-input-signals]]
=== Входные сигналы

* rst_n - асинхронный общий сигнал сброса
* clk - сигнал тактовой частоты
* [31:0] D_in - порт для записи данных в регистры
* wr_en - После установки в 1 в выбранный портом А регистр записывается необходимое число
* addr - порт адреса регистра. "0" - регистр данных, "1" - регистр конфигурации и состояния

[[trans-output-signals]]
==== Выходные сигналы

* SL0 - сигнал нулей SL канала
* SL1 - сигнал единиц SL канала
* [31:0] D_out - порт для чтения регистров
* irq - вывод прерывания

[[trans-inout-signals]]
=== Двунаправленные сигналы

Отсутствуют.


[[trans-programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

* Регистр конфигурации и состояния (config_r и status_r)
* Данных к отправке (txdata_r)

=== Регистр конфигурации и состояния

Регистр конфигурации и состояния состоит из двух объединеных  регистров -
конфигурации и состояния. Регистру конфигурации соответвуют младшие 16 разрядов, регистру состояния - старшие.

.Назначение разрядов регистра конфигурации  (config_r)
[cols="16*^", width=99%]
|===
|0     |1 |2 |3 |4 |5  |6       |7       |8    |9     |10   |11   |12   |13   |14    |15
|SR  6+|BC[6:0]                 |IRQM  3+|FQM[9:7]          |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра конфигурации (config_r)
. SR - soft reset, включает (SR=1) и выключает (SR=0) приемник
. BC - bit count, количество бит данных в отправляемом сообщении
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля
. FQM - frequency mode, соответствие значения FQM и делителя частоты описано в таблице ниже.

.Связь значения FQM и частоты работы передатчика
[cols="2*^", width=99%]
|===
|Значение FQM в десятичной системе     | Делитель частоты
|1                                     |2
|2                                     |4
|3                                     |8
|4                                     |16
|5                                     |32
|>5                                    |32
|===

.Назначение разрядов регистра состояния (status_r)
[cols="16*^", width=99%]
|===
|16    |17   |18   |19   |20   |21   |22   |23     |24    |25    |26    |27     |28   |29   |30   |31
|SIP   |Res* |Res* |Res* |Res* |Res* |Res* |Res*   |IRQSM |IRQCC |IRQIC |IRQDWE |Res* |Res* |Res* |Res*
|===

.Описание разрядов регистра состояния (status_r)
. SIP - send in process, сообщение отправлется, при попытке перезаписи этого бита ничего не происходит
. IRQSM - interrupt request of sent message, прерывание успешно отправленного сообщения
. IRQWCC - interrupt request of wrong configuration changed, прерывание попытки сменить конфигурацию во время отправки сообщения
. IRQIC - interrupt request of incorrect configuration, прерывание попытки установить неверную конфигурацию
. IRQDWE - interrupt request of data write error, прерывание попытки записать сообщение во время отправки предыдущего

=== Регистр данных к отправке
txdata_r[31:0]

.Назначение разрядов регистра данных к отправке (txdata_r)
[cols="1*^", width=99%]
|===
|0 - 31
|Data
|===

Data - данные к отправке.

== Описание работы

Модуль отправляет SL-сообщения. Сообщения могут содержать информацию четной разрядности от 8 до 32 бит.
 Бит четности формируется автоматически. Частота импульсов может меняться от 500кГц
 до 16МГц (при частоте тактового сигнала = 16МГц).

.Запись и чтение регистров
Управление модулем осуществляется путем записи/чтения регистров.

Для считывания текущего значения одного из регистров блока необходимо сформировать на шине addr соответствующее ему значение,
указанное в таблице, длительностью не меньше такта опорной тактовой частоты.
Значение регистра будет сформировано на шине d_out через такт опорной после фронта сигнала на шине addr.
Значение шины d_out будет соответствовать значению последнего опрошенного регистра до формирования следующего запроса.

Для записи значения в один из регистров блока необходимо сформировать:
* на шине addr соответствующее ему значение, указанное в таблице
* на шине d_in записываемую информацию,
* на порт wr_en - значение "1".
Также на на шине d_out через такт опорной после фронта сигнала на шине addr будет сформировано значение этого регистра.
Значение шины d_out будет соответствовать значению последнего опрошенного или записанного регистра до формирования следующего запроса.

Запись в регистр данных во время отправки сообщения, приведет к сбросу отправки,

.Смена конфигурации
Для изменения конфигурации приемника необходимо перезаписать регистр конфигурации и состояния.
В конфигурационной части может быть установлена необходимая частота, длинна слова, разрешение формирование запроса на прерывание, или осуществить сброс модуля к исходным настройкам, делитель частоты, длину сообщения, разрешение формирования прерываний.
Неверной считается конфигурация с нечетными длиннами слова или длинной слова лежащей вне промежутка от 8 до 32 бит.

.Отправка сообщений
Для отправки сообщения необходимо записать отправляемое сообщение в регистр данных.
Сразу после записи модуль переходит в режим отправки сообщения. При этом
поле SIP регистра состояния устанавливается в "1".

В случае когда поле BC регистра конфигурации не равно 32, отправляемым сообщением
являются младшие биты регистра данных. Старшие биты регистра, которые не входят в длинну сообщения
заданную конфигурацией ( txdata[31:32-BC] ) будут записаны в регистр, но игнорированы при отправке.

.Прерывания
Прерывания вызываются если поле регистра конфигурации IRQM = 1 и произошло одно из событий:
* Отправка сообщения завершена
* Была предпринята попытка записать некорректные данные в конфигурационный регистр
* Изменение конфигурации в процессе отправки сообщения
* Попытка записать новые данные во время отправки старых
Причину возникновения можно посмотреть  в соотвествующих полях регистра состояния.
Для сбрасывания прерываний, вам необходимо считать регистр конфигурации и состояния и
записать считанное снова, занулив биты прерываний.


.Выключение модуля
При выключении передатчика (поле регистра конфигурации SR = "1"), передатчик прекращает отправку текущего сообщения.
 Когда передатчик выключен, запись в регистр данных игнорируется.

[[trans-state-machine]]
== Алгоритмы работы
image::image_SlTransmitter_irq_algorithm.png[title="Алгоритм работы регистра состояния модуля SlTransmitter", align="center"]
Модуль может находиться в двух режимах:
* Режим отправки
* Режим ожидания

После включения модуля, все биты регистра состояния устанавливаются в 0, модуль
находится в режиме ожидания.

В режиме ожидания при записи регистра конфигурации и состояния происходит проверка
 битов прерываний: если значения соответствующих записываемых битов прерываний равны 0,
  то они сбрасываются. После этого если конфигурация некорректна, выставляется IRQIC = 1,
 конфигурация не изменяется. Модуль остается в режиме ожидания.

При записи данных в режиме ожидания, модуль переходит в режим отправки,
устанавливается поле  регистра состояний SIP = 1.

Если в режиме отправки происходит запись данных, выставляется бит IRQDWE = 1,
модуль возвращается в режим ожидания, выставляются биты SIP = 0 и IRQSM = 1.

Если в режиме отправки происходит запись регистра конфигурации и состояния,
сначала проверяются биты прерываний: если значения соответствующих записываемых
битов прерываний равны 0, то они сбрасываются. После этого, проверяется изменяются
ли биты конфигурации (поля FQM, BC, SR). Если они не изменяются, модуль остается
в режиме отправки сообщения. Если они изменяются то отправка завершается, выставляются
биты SIP = 0 и IRQSM = 1. Если конфигурация корректна, она записывается в регистр.
Модуль переходит в режим ожидания записи.

image::image_SlTransmitter_send_algorithm.png[title="Алгоритм работы модуля SlTransmitter в режиме отправки", align="center"]

В начале режима отправки в сдвиговый регистр загружается отправляемое сообщение.
Счетчики количества бит и частоты устанавливаются в 0.
Счетчик частоты считает от 0 до значения (делитель частоты - 1). Когда счетчик частоты достигает максимального значения,
 инкрементируется счетчик количества бит.
Счетчик количества бит считает от нуля до числа, равного (BC + 1)*2+1, где BC (bit count) - поле регистра кионфигурации.

При нулевом значении счетчика частоты на линии канала выставляется значение, зависящее от значения счетчика битов.

На значениях счетчика битов 0, 2, ...., (BC-1)*2 на выход выставляется комбинация соответвующая первому биту сдвигового регистра.
Также происходит подсчет четности на основе первого бита сдвигового регистра и сдвиг регистра.

На нечетных значениях счетчика битов 1, 3, ...., (BC+1)*2+1 на выход выставляется комбинация соответвующая промежутку между значащими битами (единица на линии нулей и единица на линии единиц)

На значении счетчика битов BC*2 на выход выставляется комбинация соответвующая подсчитанной четности, а на значении (BC+1)*2 - комбинация стоп бита.

Также на каждом значении счетчика частоты происходит проверка наличия ошибок - попытки записать данные во время отправки или изменения конфигурации. В случае, если ошибка произошла, отправка прекращается.

В результате на выходе модуля формируется sl - сообщение.
