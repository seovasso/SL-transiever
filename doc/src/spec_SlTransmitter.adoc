= Спецификация модуля передатчика SL-канала : *SlTransmitter*
//===========
// Compile:
// evgeniy@N7-63:~/Documents/2015VV024/doc$ asciidoctor-pdf -a pdf-style=/home/evgeniy/Documents/RISC-V/fizika-theme.yml -a pdf-fontsdir=/home/evgeniy/Downloads/fonts/Combo/ ./src/2015VV024_datasheet.adoc && mv ./src/2015VV024_datasheet.pdf ./ && evince ./2015VV024_datasheet.pdf
:Authors: Василий Мочалов
:Email:   seovasso@gmail.com
:Date:      31.01.2017
:Revision:  0.3
:toc:       right
:toclevels: 3
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/
:sectnums:
:sectnumlevels: 3
:revnumber: 1.1
:revdate:   15.12.2017
:revremark: Рабочая версия

[[trans-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального передатчика SL-канала. Передатчик отправляет SL-сообщения. Сообщения могут содержать информацию четной разрядности от 8 до 32 бит. Бит четности формируется автоматически. Частота импульсов может меняться от 500кГц до 16МГц (при частоте тактового сигнала = 16МГц).

[[sl-channel-review-2]]
== Описание SL-канала
SL - канал - последовательный однонаправленный канал обмена данными, разработанный для внутриплатного и межплатного обмена информацией. Обмен данными типа "точка-с-точкой". Канал состоит из двух линий: линии единиц и линии нулей. Пассивный уровень на линиях - единица. В случае передачи данных каждый разряд кодируется отрицательным импульсом на соответствующей линии. Информация передается словами младшими разрядами вперед. Предпоследний разряд - четность. Передатчик вычисляет четность таким образом, чтобы количество импульсов на линии единиц с учетом разряда четности было нечетным, а на линии нулей - четным. Приемник контролирует четность индивидуально по каждой линии. Последним импульсом является синхроимпульс, представляющий собой отрицательные импульсы по обоим линиям одновременно. Синхроимпульс означает, что передача закончена. Не допускается перекрытия информационных импульсов во время передачи.

image::SL.png[title="Временная диаграмма SL-канала", align="center"]

Типичная рабочая частота передатчика, спроектированного в синхронном стиле, составляет от 500кГц до 1МГц. Пауза между информационными битами равна длительности отрицательного импульса.

[[trans-top-level-description]]
== Описание верхнего уровня передатчика

.Порты цифрового модуля SlTransmitter
[cols="3*^1,1*^2,1*<3", halign="left", width=99%]
|===
|Название      |Тип   |Разрядность |Значение после сброса |Описание
|_rst_n_       |In    |1           | -                    |Асинхронный общий сигнал сброса
|_clk_         |In    |1           | -                    |Сигнал тактовой частоты
|_addr_        |In    |1           | -                    |Сигнал выбора регистра
|_wr_en_       |In    |1           | -                    |Сигнал разрешения записи
|_D_in_        |In    |32          | -                    |Данные для записи в регистры
|_SL0_         |Out   |1           |b1                    |Сигнал нулей SL канала
|_SL1_         |Out   |1           |b1                    |Сигнал единиц SL канала
|_irq_         |Out   |1           |b0                    |Сигнал запроса на прерывание
|_D_out_       |Out   |32          |h0000_0000            |Данные для чтения регистров
|===

<<<

[[trans-programm-model]]
== Программная модель
Пользователю для работы доступно два регистра:

* Служебный (*config_status_r*)
* Данных к отправке (*txdata_r*)

=== Служебный регистр

Служебный регистр состоит из двух частей - конфигурации и состояния. Части отвечающей за конфигурацию соответствуют младшие 16 разрядов, части состояния старшие.

[[tr_conf_table]]
.Назначение разрядов конфигурационной части служебного регистра (*config_status_r [15:0]*)
[cols="16*^", width=99%]
|===
|Bit        |15-14 |  13 |12 |11 |10 |9  |8  |7     |6 |5 |4 |3 |2 |1 |0
|Name       |-   4+|*IRQM[3:0]*    3+|*FQM[2:0]*  6+|*BC[5:0]*        |*SR*
|Mode       |R   4+|R/W            3+|R/W         6+|R/W              |R/W
|Initial    |0     |0  |0  |0  |0    |0  |0  |0     |0 |0 |1 |0 |0 |0 |0
|===

.Описание разрядов регистра конфигурационной части служебного регистра (*config_status_r [15:0]*)
. *SR* (soft reset) -- включает (*SR* = 0) и выключает (*SR* = 1) приемник
. *BC* (bit count) -- количество разрядов данных в отправляемом сообщении
. *IRQM* (interrupt request mask) -- маска разрядов причин прерываний.
  Задает, какие именно разряды причин прерываний вызывают запрос на прерывание. Описание разрядов причин прерываний можно посмотреть в <<trans_IRQM_table,таблице назначения разрядов части состояния служебного регистра>>. Соответствие разрядов поля *IRQM* и разрядов причин прерываний можно посмотреть в соответствующей <<trans_IRQM_table, таблице>>
. *FQM* (frequency mode) -- Поле настройки частоты выходного сигнала. Соответствие значения *FQM* и делителя частоты описано в <<trans_FQM_table, таблице>> ниже.

[[trans_FQM_table]]
.Соответствие значения поля *FQM [2:0]* и делителя частоты работы передатчика
[cols="4*^", width=99%]
|===
|FQM2 |FQM1 | FQM0   | Делитель частоты
|0    |0    |1       |2
|0    |1    |0       |4
|0    |1    |1       |8
|1    |0    |0       |16
|0    |0    |0       |32
|1    |0    |1       |32
|1    |1    |0       |32
|1    |1    |1       |32
|===

[[trans_status_part_table]]
.Назначение разрядов части состояния служебного регистра (*config_status_r [31:16]*)
[cols="8*^", width=99%]
|===
|Bit     |31-28 |27       |26       |25       |24      |23-17 |16
|Name    |-     |*IRQDWE* |*IRQICC* |*IRQWCC* |*IRQSM* |-     |*SIP*
|Mode    |R     |R/W0     |R/W0     |R/W0     |R/W0    |R     |R
|Initial |0     |0        |0        |0        |0       |0     |0
|===

.Описание разрядов части состояния служебного регистра (*config_status_r [31:16]*)
. *SIP* (send in process) -- разряд идущего процесса отправки сообщения.
. *IRQSM* (interrupt request of sent message) -- разряд запроса на прерывание отправленного сообщения.
. *IRQWCC* (interrupt request of wrong configuration change) -- разряд запроса на прерывание попытки сменить конфигурацию во время отправки сообщения.
. *IRQICC* (interrupt request of incorrect  configuration change ) -- разряд запроса на прерывание попытки установить некорректную конфигурацию.
. *IRQDWE* (interrupt request of data write error) -- разряд запроса на прерывание попытки записать сообщение во время отправки предыдущего.

Разряды *IRQSM*, *IRQWCC*, *IRQICC* и *IRQDWE* отражают зарегистрированные передатчиком события. Более подробно события описаны разделе Работа с программной моделью -> <<trans_irq_events, Работа с прерываниями>>.

[[trans_IRQM_table]]
.Соответствие разрядов <<tr_conf_table,*IRQM [3:0]*>> и маскирования разрядов причин прерываний
[cols="2*^", width=99%]
|===
|Разряд поля *IRQM*                       |Маскируемый разряд
|*IRQM0*                                  |*IRQSM*
|*IRQM1*                                  |*IRQWCC*
|*IRQM2*                                  |*IRQICC*
|*IRQM3*                                  |*IRQDWE*
|===

=== Регистр данных к отправке

.Назначение разрядов регистра данных к отправке (*txdata_r*)
[cols="2*^", width=99%]
|===
|Bit     |31 - 0
|Name    |*DATA*
|Mode    |R/W
|Initial |0
|===
.Описание разрядов регистра  данных к отправке (*txdata_r*)
*DATA* - данные к отправке.

<<<

== Работа с программной моделью

=== Запись и чтение регистров
Управление модулем осуществляется путем записи или чтения регистров.

Для считывания текущего значения одного из регистров блока необходимо подать на порт _addr_ адрес регистра, указанный в <<trans_addr_table, таблице>>, длительностью не меньше такта опорной тактовой частоты _clk_. Значение регистра будет сформировано на шине _D_out_ через такт опорной частоты после фронта сигнала на шине _addr_.

Для записи значения в один из регистров блока необходимо сформировать:

* на порт _addr_ -- адрес регистра
* на шине _D_in_ -- записываемую информацию,
* на порт _wr_en_ -- значение 1.

Также на на шине d_out через такт опорной частоты _clk_ после фронта сигнала на шине _addr_ будет сформировано значение записанного регистра. Значение шины d_out будет соответствовать значению последнего опрошенного или записанного регистра до формирования следующего запроса.

image::image_SlTransmitter_read_write_waveform.png[title="Временная диаграмма чтения и записи регистров модуля SlTransmitter", align="center"]

[[trans_addr_table]]
.Адреса регистров
[cols="2*^", width=99%]
|===
|Значение сигнала _addr_  | Выбранный регистр
|b0                       | регистр данных (txdata_r)
|b1                       | служебный регистр (config_status_r)
|===


=== Отправка сообщений

Для отправки сообщений необходимо:

. Записать в регистр *config_r* необходимые настройки частоты и длины слова (см. раздел "<<trans_config_change, Смена конфигурации>>")
. Записать в регистр данных сообщение на отправку
. Дождавшись запроса на прерывания вызванного отправкой сообщения, или, работая по таймеру и периодически опрашивая регистр состояния, убедится, что сообщение было отправлено  (*IRQSM* == 1).
. Сбросить поле причины прерывания *IRQSM*. Возможна работа без сбрасывания поля *IRQSM*, тогда необходимо контролировать завершение отправки предыдущего сообщения по таймеру.
. Записать в регистр данных следующее сообщение.

Сразу после записи в регистр данных модуль переходит в режим отправки сообщения. При этом поле *SIP* регистра состояния устанавливается в "1".

В случае когда поле BC служебного регистра не равно 32, отправляемым сообщением являются младшие разряды регистра данных. Старшие разряды регистра, которые не входят в длину сообщения, заданную полем *BC* служебного регистра (*txdata_r [31:32-BC]*), будут записаны в регистр, но игнорированы при отправке.

Во время отправки сообщения нельзя записывать новое сообщение - отправка будет прекращена (см. раздел Алгоритм работы -> <<trans_end_send, Прекращение отправки>>), модуль вернется в режим ожидания нового сообщения.

Если отправка не была прервана попыткой изменения конфигурации или записью следующего сообщения, в конце отправки будет выставлен разряд *IRQSM* = 1, и разряд *SIP* = 0. Если разряд *IRQSM* не замаскирован (см. таблицу описания поля <<trans_IRQM_table, IRQM>>), возникнет запрос на прерывание.


[[trans_config_change]]
=== Смена конфигурации

Для изменения конфигурации передатчика необходимо:

1. Считав служебный регистр убедится, что разряд *SIP* равен 0. Нельзя изменять поля *BC* и *FQM* во время отправки сообщения - отправка будет прервана.
2. Записать новые параметры в служебный регистр.

В конфигурационной части служебного регистра может быть установлена необходимая частота, длина слова, маскировка причин запроса прерывания или осуществлен сброс модуля к исходным настройкам.

Некорректной считается конфигурация с нечетными длинами слова или длиной слова лежащей вне промежутка от 8 до 32 разрядов. При попытке записать подобную конфигурацию будет выставлен разряд *IRQICC* = 1, а поля *BC* и *FQM* останутся неизменными.



=== Работа с прерываниями

Запрос прерывания происходит, когда произошло одно из событий и разряд причины прерываний соответствующий этому событию не замаскирован. Узнать какое именно событие вызвало запрос на прерывание можно в <<trans_status_part_table,полях причин прерываний>> служебного регистра.

[[trans_irq_events]]
.События соответствующие разрядам причин прерываний
* *IRQSM* -- Сообщение было успешно отправлено
* *IRQWCC* -- Отправка сообщения <<trans_end_send, прекращена>> из-за попытки изменения полей BC и FQM в процессе отправки.
* *IRQICC* -- Была предпринята попытка записать некорректную конфигурацию в конфигурационный регистр
* *IRQDWE* -- Отправка сообщения <<trans_end_send, прекращена>> из-за попытки записать следующее сообщение в процессе отправки.


Для сброса прерывания необходимо записать 0 в разряды причин прерываний, которые необходимо сбросить.

Более подробно работа прерываний рассмотрена в разделе <<trans-work-algorythm, Алгоритм работы>>.

=== Выключение модуля

Чтобы выключить модуль необходимо записать 1 в разряд *SR* служебного регистра.

Если сделать это во время отправки сообщения, отправка прекращается. Служебный регистр возвращается в начальное состояние, регистр данных сбрасывается. На выходах _SL0_ и _SL1_ устанавливается 1. Когда передатчик выключен, запись в регистр данных игнорируется.

<<<

[[trans-work-principle]]
== Принцип работы

Отправка сообщения обеспечивается двумя счетчиками: счетчиком импульсов и  счетчиком циклов.

Счетчик циклов обеспечивает деление частоты. Каждый раз, когда счетчик циклов оказывается равным нулю, переключается счетчик импульсов.

На нечетных значениях счетчика импульсов на выходы _SL0_ и _SL1_ подаются значения соответствующие информационным импульсам, потом импульсу четности и синхроимпульсу.

На четных значениях счетчика импульсов на выходы _SL0_ и _SL1_ подаются единицы.

[[trans-work-algorythm]]
== Алгоритм работы

В устройстве используются следующие вспомогательные сигналы и регистры:

[cols="3*^1,1*^2,1*<3", halign="left", width=99%]
|===
|Название           |Тип     |Разрядность  |Значение после сброса  |Описание
|_end_of_msg_       |сигнал  |1            |b0 |Сигнал конца сообщения
|_new_conf_is_corr_ |сигнал  |1            |b0 |Сигнал корректности разрядов шины _D_in_ соответствующих полю BC имеют корректное значение
|_config_changed_   |сигнал  |1            |b0 |Сигнал отличия разрядов шины _D_in_ соответствующих полям BC и FQM и полей BC и FQM служебного регистра
|_no_error_         |сигнал  |1            |b0 |Сигнал отстутствия ошибки в управлении регистром (смена конфигурации или запись в регистр данных во время отправки)
|_fq_max_           |сигнал  |5            |b0 |Сигнал равный <<trans_FQM_table,значению делителя частоты>> уменьшенному на 1
|*shift_r*          |регистр |1            |b0 |Сдвиговый регистр с отправляемым сообщением
|*par0*             |регистр |1            |b0 |Регистр подсчета четности на линии нулей
|*par1*             |регистр |1            |b0 |Регистр подсчета четности на линии единиц
|*fq_counter_r*     |регистр |5            |b0 |Регистр счетчика циклов
|*bit_counter_r*    |регистр |7            |b0 |Регистр счетчика количества импульсов
|===

image::image_SlTransmitter_irq_algorithm.png[title="Алгоритм работы модуля SlTransmitter", align="center"]

Модуль может находиться в двух режимах: режим отправки и режим ожидания. После включения модуля, все разряды части состояния служебного регистра устанавливаются в 0, модуль находится в режиме ожидания.

=== Смена конфигурации и сброс прерываний в режиме ожидания

При записи служебного регистра в  режиме ожидания происходит следующее:

. Если значения разрядов шины _D_in_ соответствующие разрядам полей причин прерываний служебного регистра, равны 0, то они записываются в служебный регистр.
. Обновляется поле *IRQM* служебного регистра
. Если значение разрядов шины _D_in_ соответствующие полю *BC* корректно, поля *BC* и *FQM* обновляются. Если значение некорректно, выставляется *IRQICС* = 1, поля *BC* и *FQM* не изменяются. Модуль остается в режиме ожидания.

Корректным значением поля BC называется четное число в интервале от 6'd8 до 6'd32.

=== Отправка сообщения

Сразу после записи данных в режиме ожидания, модуль переходит в режим отправки, устанавливается поле служебного регистра *SIP* = 1. По успешному окончанию отправки сообщения, устанавливаются поля *SIP* = 0 и *IRQSM* = 1. Если же отправка сообщения была прервана попыткой смены конфигурации или записи в регистр данных, выставляются устанавливаются поля *SIP* = 0 и *IRQWCC* = 1 или *IRQDWE* = 1. Поле IRQSM в случае прерванной отправки не устанавливается в 1.

=== Изменение конфигурации и сброс прерываний во время отправки сообщения

При записи служебного регистра в  режиме отправки сообщения происходит проверка разрядов причин прерываний:

. Если значения разрядов шины _D_in_ соответствующие разрядам полей причин прерываний служебного регистра, равны 0, то они записываются в служебный регистр.
. Обновляется поле *IRQM* служебного регистра
. Если разряды шины _D_in_ соответствующие полям *BC* и *FQM* отличаются от полей служебного регистра выставляется *IRQWCС* = 1 и *SIP* = 0, отправка сообщения <<trans_end_send,прекращается>>.
. Если значение разрядов шины _D_in_ соответствующие полю *BC* корректно, поля *BC* и *FQM* обновляются. Если значение некорректно, выставляется *IRQICС* = 1, поля *BC* и *FQM* не изменяются.

Корректным значением поля BC называется четное числом в интервале от 6'd8 до 6'd32.

=== Формирование запроса на прерывание

Запрос на прерывание формируется на выходе _irq_, через один такт после возникновения причины прерывания, если причина этого прерывания не замаскирована в поле <<trans_IRQM_table, *IRQM [3:0]*>>.

image::image_SlTransmitter_send_algorithm.png[title="Алгоритм работы модуля SlTransmitter в режиме отправки", align="center"]

=== Режим отправки сообщений

В начале режима отправки в сдвиговый регистр загружается отправляемое сообщение. Для организации отправки используются два счетчика:

* Счетчик циклов (*bit_counter_r*)
* Счетчик импульсов (*fq_counter_r*)

=== Счетчик циклов

В режиме ожидания в счетчик циклов загружается максимальное значение _fq_max_ равное <<trans_FQM_table,делителю частоты>> уменьшенному на 1.
В режиме отправки счетчик частоты считает от значения _fq_max_ до значения 0. Когда счетчик частоты достигает нуля, счетчик импульсов увеличивается на 1, а в счетчик частоты снова загружается максимальное значение.

=== Счетчик импульсов

В режиме ожидания в счетчик импульсов загружается максимальное значение равное (*BC* + 2) &#42; 2 - 1.
В режиме отправки счетчик импульсов считает от числа, равного (*BC* + 2) &#42; 2 - 1 до 0, где BC (bit count) - поле служебного регистра. Число (*BC* + 2) &#42; 2 - 1 получено следующим образом: необходимо отправить число разрядов информации заданное полем BC, разряд четности и синхроимпульс. В сумме BC+2 импульсов. Между импульсами нужно выставить на выход промежуточную комбинацию, таким образом, значение удваивается и получается (*BC* + 2) &#42; 2 итераций счетчика и максимальное значение равное (*BC* + 2) &#42; 2 - 1.

=== Соответствие значения счетчика импульса и значений на выходах SL0 и SL1

На значениях счетчика импульсов (*BC* + 2) &#42; 2 - 1, (*BC* + 2) &#42; 2 - 3,  ..  7, 5 на выходы _SL0_ и _SL1_ устанавливается комбинация соответствующая первому разряду сдвигового регистра. Также происходит подсчет четности на основе первого разряда сдвигового регистра и сдвиг регистра. Таким образом формируются информационные импульсы.

На всех четных значениях -- (*BC* + 1) &#42; 2, (*BC* + 1) &#42; 2 - 2, .. 2, 0  на выход устанавливается комбинация, соответствующая промежутку между отрицательными импульсами (_SL0_ = 1 и _SL1_ = 1)

На значении счетчика импульсов *bit_counter_r* = 3 на выход выставляется комбинация соответствующая подсчитанный четности, а на значении *bit_counter_r* = 1 - комбинация синхроимпульса (_SL0_ = 0 и _SL1_ = 0).

=== Подсчет четности

Подсчет четности осуществляется при помощи регистров *par0* и *par1*. Регистр *par0* имеет начальное значение 1, и инвертируется каждый раз при отправке информационного разряда со значением 0.
Регистр *par1* имеет начальное значение 0, и инвертируется каждый раз при отправке информационного разряда со значением 1.

Таким образом, если в отправляемом сообщении будет четное число единиц, то par1 и par0 изменятся четное количество раз и после отправки всех информационных разрядов получаем *par0* = 1, *par1* = 0. подав эти значения на выходы _SL0_ и _SL1_ получим отрицательный импульс на линии единиц, общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.

Если же в отправляемом сообщении будет четное число единиц, то *par1* и *par0* изменятся нечетное количество раз и после отправки всех информационных разрядов получаем *par0* = 0, *par1* = 1. подав эти значения на выходы _SL0_ и _SL1_ получим отрицательный импульс на линии нулей, общее же количество импульсов на линии единиц окажется нечетным, а на линии нулей - четным.

[[trans_end_send]]
=== Прекращение отправки

На каждом значении счетчика частоты происходит проверка наличия ошибок - попытки записать данные во время отправки или изменения конфигурации. В случае, если ошибка произошла, отправка прекращается: разряд причины прерывания соответствующий <<trans_irq_events, событию>>, вызвавшему прекращение отправки, устанавливается в единицу, на выходы _SL0_ и _SL1_ устанавливаются единицы, модуль готов к отправке следующего сообщения.
