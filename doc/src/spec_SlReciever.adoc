= SlReciever
:Date:      13.10.2017
:Revision:  0.1
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[rec-main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального приемника SL-канала.

[[rec-top-level-description]]
== Описание верхнего уровня

[[rec-input-signals]]
=== Входные сигналы
* rst_n - асинхронный общий сигнал сброса
* clk - сигнал тактовой частоты
* [31:0] D_in - порт для записи данных в регистры
* wr_en - После установки в 1 в выбранный портом addr регистр записывается необходимое число
* addr - адрес регистра "0" - регистр данных, "1" - регистр конфигурации и состояния
* serial_line_zeroes_a - асинхронный вход линии нулей SL-канала
* serial_line_ones_a - асинхронный вход линии единий SL-канала

[[rec-output-signals]]
=== Выходные сигналы
* [31:0] D_out - порт для чтения регистров
* irq - вывод прерывания

[[rec-inout-signals]]
=== Двунаправленные сигналы

Отсутствуют.

[[rec-programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

* Регистр конфигурации и состояния (config_r и status_r)
* Регистр последнего успешно принятого сообщения (buffered_data_r)

=== Регистр конфигурации и состояния

Регистр конфигурации и состояния состоит из двух объединеных  регистров -
регистра конфигурации и регистра состояния. Регистру конфигурации соответвуют младшие 16 разрядов, регистру состояния - старшие.

.Назначение разрядов регистра конфигурации  (config_r)
[cols="16*^", width=99%]
|===
|0     |1     |2 |3 |4 |5 |6    |7      |8    |9      |10   |11   |12   |13   |14    |15
|SR  6+|BC[6:0]                 |PCE  6+|IRQM                                 |Res*  |Res*
|===

.Описание разрядов регистра конфигурации (config_r)
. SR - soft reset, включает (SR=1) и выключает (SR=0) приемник
. BC - bit count, количество бит в слове
. IRQM - interrupt request mask, маскирование прерываний модуля
. PCE - parity check enable, разрешение контроля четности(PCE = 1), или запрещение(PCE = 0)

.Связь разрядов IRQM и маскирования причин прерываний
[cols="2*^", width=99%]
|===
|Разряд поля IRQM     | Маскируемый бит
|IRQM[0]              |IRQRM
|IRQM[1]              |IRQPEM
|IRQM[2]              |IRQWLC
|IRQM[3]              |IRQLE
|IRQM[4]              |IRQWCC
|IRQM[5]              |IRQICC
|===

.Назначение разрядов регистра состояния (status_r)
[cols="16*^", width=99%]
|===
|16    |17   |18   |19   |20   |21   |22   |23    |24    |25     |26     |27     |28     |29     |30     |31
|WRP   |PEF  |Res* |Res* |Res* |Res* |Res* |Res*  |Res*  |IRQRM  |IRQPEM |IRQWLC |IRQLEF |IRQWCC |IRQICС |Res*
|===

.Описание разрядов регистра состояния (status_r)
. WRP - word receiving process, флаг идущего процесса приема слова по SL-каналу
. PEF - parity error flag, присутствует ли ошибка четности в хранящемся в буфере сообщении
. IRQRM - interrupt request of recieved message - прерывание успешно принятого сообщения
. IRQPEM - interrupt request of parity error message, принято слово не прошедшее проверку четности
. IRQWLC - interrupt request of word length check, принято слово не прошедшее проверку длины полученного слова на равенство значению BC регистра config_r
. IRQLE - interrupt request of level error on line, прерывание ошибки уровня напряжения на линии SL-канала
. IRQWCC - interrupt request of wrong configuration changed - прерывание смены конфигурации во время приема сообщения
. IRQICC - interrupt request of incorrect configuration  прерывание попытки смены конфигурации на неверную
. Res* - Зарезервированно

=== Регистр полученных данных
buffered_data_r[31:0]

.Назначение разрядов регистра полученных данных (buffered_data_r)
[cols="1*^", width=99%]
|===
|0 - 31
|Data
|===

Data - данные к отправке.


== Описание работы

Модуль принимает SL-сообщения. Сообщения могут иметь четную длинну от 8 до 32 бит.
Бит четности проверяется автоматически. Частота импульсов принимаемых сообщений может меняться от 500кГц
до 2МГц (при частоте тактового сигнала = 16МГц).

*Запись и чтение регистров*

Управление модулем осуществляется путем записи/чтения регистров.

Для считывания текущего значения одного из регистров блока необходимо сформировать на шине addr соответствующее ему значение,
указанное в таблице, длительностью не меньше такта опорной тактовой частоты.
Значение регистра будет сформировано на шине d_out через такт опорной после фронта сигнала на шине addr.

Для записи значения в один из регистров блока необходимо сформировать:

* на шине addr значение соотвествующее регистру
* на шине d_in записываемую информацию,
* на порт wr_en - значение "1".

Также на на шине d_out через такт опорной после фронта сигнала на шине addr будет сформировано значение записанного регистра.
Значение шины d_out будет соответствовать значению последнего опрошенного или записанного регистра до формирования следующего запроса.

.Адреса регистров
[cols="2*^", width=99%]
|===
|Значение шины addr | Выбранный регистр
|1'b0               | регистр данных
|1'b1               | регистр конфигурации и состояния
|===

*Смена конфигурации*

Для изменения конфигурации приемника необходимо перезаписать регистр конфигурации и состояния.
В конфигурационной части может быть установлена длинна слова,
 маскировка причин запроса перывания или осуществлен сброс модуля к исходным настройкам.
Неверной считается конфигурация с нечетными длиннами слова или длинной слова лежащей вне промежутка от 8 до 32 бит.

*Прием сообщений*
Если на вход модуля начинают поступать импульсы, модуль переходит в режим приема сообщения,
выставляется бит WRP = 1.

Модуль переходит в режим ожидания нового сообщения в сиутациях

* Успешного приема сообщения
* Приема сообщения с ошибкой
* Завершившейся ошибки уровня на линии

При переходе

Успешным приемом сообщения называется прием сообщения с совпадающим со значением поля
BC количеством информационных бит и, если включен контроль четности, верной четностью.
В случае, если успешно принято слово с правильной четностью выставляется бит IRQRM = 1 и WRP = 0.
Если контроль четности отключен успешно принято слово с неправильной четностью, выставляются биты
IRQPEM = 1, PEF = 1 и  WRP = 0.

В случае приема сообщения с ошибкой выставляются биты:

* Контроль четности включен и принято сообщение с ошибкой четности -- IRQPEM = 1 и  WRP = 0
* Принято сообщение с несовпадающим с конфигурацией количесвом бит -- IRQWLC = 1 и  WRP = 0

В случае, если во время приема произошла ошибка уровня, выставляется флаг IRQLEF = 1.
Модуль вернется в режим ожидания сообщения только когда уровни на линиях будут восстановлены.
До этого момента будет флаг WRP = 1, а бит причины прерывания IRQLEF будет невозможно сбросить.

В регистре данных всегда хранится последнее успешно принятое сообщение.
А в бите PEF - наличие ошибки четности последнего успешно принятого сообщения.

После считывания сообщения необходимо сбросить бит IRQRM, и ожидать следующего сообщения.

*Прерывания*

Запрос прерывания проиходит произошло одно из событий и бит этого события не замаскирован :

* Успешно принято сообщение (IRQRM)
* Принято сообщение с ошибкой четности (IRQPEM)
* Принято сообщение неверной длинны (IRQWLC)
* Произошла ошибка уровня на линии (IRQLE)
* Была предпринята попытка записать некорректные данные в конфигурационный регистр (IRQICC)
* Изменение конфигурации в процессе отправки сообщения (IRQWCC)


Причину возникновения можно посмотреть  в соотвествующих полях регистра состояния.
Для сбрасывания прерываний, вам необходимо считать регистр конфигурации и состояния и
записать считанное снова, занулив биты прерываний. Более подробно работа прерываний
рассмотрена в разделе Алгоритм работы.


*Выключение модуля*

Чтобы выключить модуль необходимо выставить поле регистра конфигурации SR = "1".
Если сделать это во время отправки сообщения, прием сообщения прекращается.
Регистры конфигурации и состояния возвращаются в начальное состояние.
Когда приемник выключен, он не реагирует на сигналы на входах SL0 и SL1.

[[rec-irq-Algorythm]]
== Алгоритмы работы
image::image_SlReciever_irq_algorithm.png[title="Алгоритм работы регистра состояния модуля SlReciever", align="center"]

[[rec-state-machine]]
== Конечный автомат
image::image_SlReciever_SM.png[title="Конечный автомат модуля SlReciever", align="center"]
module SlReceiver #(parameter STATUS_WIDTH = 16,
Каждый такт значение асинхронных входов serial_line_zeroes_a и serial_line_ones_a
загружается в в первый разряд сдвиговых регистров sl0_tmp_r[15:0] и sl1_tmp_r[15:0],
регистры сдвигаются.

Когда прием сообщения не начат, модуль находится в состоянии BIT_WAIT_FLUSH,
