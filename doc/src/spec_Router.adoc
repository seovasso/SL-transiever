= Router
:Date:      25.01.2018
:Revision:  0.3
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[router-main-description]]
== Описание
Модуль   используется в проекте приемопередатчика SL канала для чтения управляющих данных из первого асинхронного буфера и распределения их выбранному приемнику и передатчику, и записи данных о состоянии приемника / передатчика во второй асинхронный буфер . 


[[router-top-level-description]]
== Описание верхнего уровня

[[router-input-signals]]
=== Входные сигналы
.Общие сигналы
* clk - системный клок
* rst_n - системный ресет

.Сигналы передатчика
* [CHANNEL_COUNT-1:0] rd_status_tx - массив выводов регистров состояния передатчиков
* [TX_CONFIG_REG_WIDTH*CHANNEL_COUNT-1:0] rd_config_tx - массив выводов регистров конфигурационных регистров передатчиков
* [CHANNEL_COUNT-1:0] status_changed_tx - массив выводов сигналов изменения регистра состояния

.Сигналы приемника
* [RX_STATUS_REG_WIDTH*CHANNEL_COUNT-1:0] rd_status_rx - смассив выводов регистров состояния приемников
* [RX_CONFIG_REG_WIDTH*CHANNEL_COUNT-1:0] rd_config_rx - массив выводов конфигурационных регистров приемников
* [32*CHANNEL_COUNT-1:0] rd_data_rx - массив выводов регистров данных приемников
* [CHANNEL_COUNT-1:0] data_status_changed_tx - * status_changed_tx - массив выводов сигналов изменения регистров состояния и данных
(регистр даннных не может изменится без изменения регистра состояния)

.Сигналы асинхронных буферов
* fifo_read_empty - сигнализирует что входной буфер пуст
* fifo_write_full - сигнализирует что выходной буфер полон
* [33:0] fifo_read_data - шина данных входного буфера

[[router-output-signals]]
=== Выходные сигналы

.Сигналы передатчика
* [TX_CONFIG_REG_WIDTH*CHANNEL_COUNT-1:0] wr_config_tx - данные, которые должны быть записаны в конфигурационный регистр (массив выходов для всех передатчиков)
* [CHANNEL_COUNT-1:0] config_we_tx - сигналы записи в конфигурационный регистр (массив выходов для всех передатчиков)
* [32*CHANNEL_COUNT-1:0] wr_data_tx - данные, которые должны быть записаны в регистр для отправляемого сообщения (массив выходов для всех передатчиков)
* [CHANNEL_COUNT-1:0] data_we_tx - сигналы записывающие данные и начинающий отправку сообщения (массив выходов для всех передатчиков)

.Сигналы приемника
* [RX_CONFIG_REG_WIDTH*CHANNEL_COUNT-1:0] wr_config_rx - данные, которые должны быть записаны в конфигурационный регистр (массив выходов для всех передатчиков)
* [CHANNEL_COUNT-1:0] config_we_rx - сигналы для записи в конфигурационный регистр (массив выходов для всех передатчиков)
* [CHANNEL_COUNT-1:0] word_picked_rx - сигнал для сброса бита принятого слова  (массив выходов для всех передатчиков)

.Сигналы входного и выходного буферов
* fifo_read_inc - сигнал для чтения из входного буфера (массив выходов для всех передатчиков)
* [33:0] fifo_write_data - шина данных выходного буфера (массив выходов для всех передатчиков)
* fifo_write_inc - сигнал для записи в выходной буфера (массив выходов для всех передатчиков)

[[router-inout-signals]]
=== Двунаправленные сигналы
Отсутствуют


[[router-programm-model]]
== Программная модель
.Пользователю для работы доступен регистр:
. Регистр адреса управляемого устройства

Перезаписать содержимое этого регистра можно, поместив во входной асинхронный буфер сообщение с адресом устройства и соотвествующим идентификатором.

.Значения первого бита регистра адреса управляемого устройства
* "0"  - модуль сконфигурирован для работы как передатчик
* "1"  - модуль сконифгурирован для работы как приемник

Модуль параметризуется значением параметра  CHANNEL_COUNT, для возможности подключить N передатчиков и N приемников.
Таким образом адреса приемников имеют четный адрес, а адреса передатчиков имеют нечетный адрес. Все биты адреса кроме первого, задают номер устройства.


[[router-work-description]]
== Описание работы модуля
Работа модуля делится на две части - обработка команд поступающих из входного буфера, и чтение данных регистров и потравка их содержиомого через в выходной буфер.
Все данные поступающие из входного буфера и записываемые в выходной снабжаются следующими модификаторами (33 и 34 разряды содержимого сообщения).


.Значения модификаторов для разных регистров
[cols="2*^", width=99%]
|===
|Регистр                   |Значение модификатора
|Конфигурационый           | 2'd0
|Данных                    | 2'd1
|Состояния                 | 2'd2
|Адреса устройства         | 2'd3
|===

.Обработка сообщений из входного буфера
Для обработки сообщений из входного буфера используется машина состояний, работающая по следующему алгоритму:
В зависимости от текущего состояния регистра адреса устройства, сообщение читаемое из буфера считается сообщением для соотвествующего устройства.
Если выполнены следующие условия, то машина состоний переходит из состояния ожидания в соответвующее состояние обработки сообщения

.Условия перехода
* Буфер не пуст
* Приемник/передатчик не занят (Для сообщений данных и конфигурации)

При этом, при попытке записать данные в передатчик (у него нет входа для регистра данных), а также при сообщении содержащим данные для регистра состояния (запись в регистр состояния запрещена), собщение просто уничтожается.
В случае смены устройства, содержимое сообщения записывается в регистр адреса устройства,
В случае изменения данных передатчика/приемника на соотвествующие выходы подается сообщение из буфера и write_enable для соответсвующего входа выставляется в "1".

Следующим тактом машина состояний возвращается в состояние ожидания сообщения, единицы на выходах write_enable переключаются в 0.
При смене устройства и управлении конфигурационными регистрами генерируются внутренние сигналы "channel_changed" , "rx_config_changed", "tx_config_changed". Их назначение будет описано далее.
.Запись сообщений в выходной буфер
В выходной буфер записываются сообщения следующим образом:

.Серия сообщений записываемая при смене адреса устройства (addr_changed == 1)
* текущий адрес управляемого устройства
* регистр данных текущего устройства (только для приемников)
* регистр состояния текущего устройства
* конфигурационный регистр текущего устройства

.Серия сообщений записываемая при смене регистра состояния модуля, находящегося на текущем устройстве (data_status_changed_rx == 1 , status_changed_tx == 1)
* регистр данных текущего устройства (только для приемников)
* регистр состояния текущего устройства
* конфигурационный регистр текущего устройства

При config_changed_rx == 1 и config_changed_tx == 1 в асинхронный буфер записывается сообщение с данными регистра выбранного устройства.

При возникновении коннкурируещего импульса, он будет игнорирован. Возникновение таких ситуаций не предусматривается другими модулями.

[[router-state-machine]]
=== Конечный автомат

image::image_Router_SM.png[title="Конечный автомат транзакций записи в регистры", align="center"]
image::image_Router_SM_2.png[title="Конечный автомат транзакций чтения регистров", align="center"]
