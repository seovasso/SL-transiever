= ApbCommunicator
:Date:      31.11.2017
:Revision:  0.5
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[communicator-main-description]]
== Описание
Модуль используется в проекте приемопередатчика SL канала для обработки APB транзакций, записи в выходной асинхронный буфер и считывания из входных асинхронных буферов.


[[communicator-params]]
== Параметры Конфигурации
[cols="2*^1,1*<2", halign="left", width=99%]
|===
|Название      |Значение по умолчанию |Описание
|CC            |2                     |Channel count -- количество каналов в устройстве. _Допустимые значения: значения от 1 до 16_
|===

[[communicator-top-level-description]]
== Описание верхнего уровня
.Порты цифрового модуля SlReciever
[cols="3*^1,1*^2,1*<3", halign="left", width=99%]
|===
|Название      |Тип   |Разрядность |Значение после сброса |Описание
|_rst_n_       |In    |1           | -                    |Асинхронный общий сигнал сброса
|_clk_         |In    |1           | -                    |Сигнал тактовой частоты
5+|APB-связанные сигналы
|_prst_n_      |In    |1           | -                    |Асинхронный сигнал сброса
|_pclk_        |In    |1           | -                    |Cигнал тактовой частоты
|_psel_        |In    |1           | -                    |Cигнал выбора устройства
|_penable_     |In    |1           | -                    |Cигнал разрешения работы
|_pwrite_      |In    |1           | -                    |Cигнал выбора чтения или записи
|_paddr_       |In    |16          | -                    |Шина адреса
|_pwdata_      |In    |32          | -                    |Шина записи данных
|_prdata_      |Out   |32          |h0000_0000            |Шина чтения данных
|_pready_      |Out   |1           |b0                    |Cигнал готовности к чтению или записи данных
5+|Сигналы асинхронных буферов
|_rd_fifo_empty_ |in     |CCx2x1           | -                    |Сигнал пустоты входного буфера
|_wr_fifo_full_  |in     |1                | -                    |Сигнал заполненности выходного буфера
|_wr_fifo_data_  |In     |34               | -                    |Шина данных выходного буфера
|_rd_fifo_inc_   |Out    |CCx2x1           | -                    |Cигнал для чтения из входного буфера
|_wr_fifo_inc_   |Out    |1                | -                    |Сигнал для записи в выходной буфера
|_rd_fifo_data_  |Out    |CCx2x34          | -                    |Шина данных входного буфера
|===

[[communicator-programm-model]]
== Программная модель
.Пользователю для работы доступно несколько регистров:
Пользователю для работы доступно

* Регистр Управления (*control_r*)
* Память служебных регистров устройств (*[CC*2-1 : 0] conf_stat_r*)
* Память регистров данных устройств    (*[CC*2-1 : 0] data_r*)

=== Служебный регистр устройства
.Назначение разрядов ячейки памяти служебных регистров (*conf_stat_r*)
[cols="2*^", width=99%]
|===
|Bit     |31 - 0
|Name    |*CONFSTAT*
|Mode    |R
|Initial |0
|===

.Назначение разрядов ячейки памяти служебных регистров устройств (*config_status_r*)
*CONFSTAT* - содержимое служебного регистра выбранного устройства


=== Регистр данных
.Назначение разрядов ячейки памяти данных устройства(*data_r*)
[cols="2*^", width=99%]
|===
|Bit     |31 - 0
|Name    |*DATA*
|Mode    |R/W
|Initial |0
|===
.Описание разрядов ячейки памяти данных устройства(*txdata_r*)
*DATA* - содержимое регистра данных выбранного устройства.

=== Служебный регистр
[[communicator_addr_table]]
.Назначение разрядов регистра управления (*config_status_r*)
[cols="1*^,6*^2", width=99%]
|===
|Bit        |31     |log2(CC):24   |23:CC/2-1+16 |(CC/2-1+16):16 |15:CC |СС-1:0
|Name       |-      |IRQС          |-            |LOOP           |-   7+|MODE
|Mode       |R      |R             |R            |R/W            |R   7+|R/W
|Initial    |0      |0             |0            |               |0     |0
|===
.Описание разрядов регистра регистра адреса устройства(*addr_r [15:0]*)
. *MODE*  -- разряды выбора является ли устройство примеником или передатчиком. Нарпимер, *MODE0* = 1 - канал 0 настроен как передатчик,  *MODE1* = 0 - канал 1 настроен как приемник/
. *LOOP*  -- включение и отключение петли
. *IRQC*  -- адрес устройства, требующего обработку прерывания

=== Описание работы модуля

В ходе работы, модуль принимает транзакции APB шины и обрабатывает их следующим образом: При транзакции записи в соответствующий регистр, данные для записи помещаются в выходной буфер, расширенные номером канала и значением поля MODE этого канала.

Каждому каналу соответствуют четыре регистра, два регистра приемника и два регистра передатчика.

При значении разряда поля MODE соответствующего регистра

Когда транзакций нет, а сообщения во входном буфере есть, то модуль переписывает данные из буфера в регистры, руководствуясь модификатором.

.Значения модификаторов для разных регистров
[cols="2*^", width=99%]
|===
|Регистр                   |Значение модификатора
|Конфигурационый           | 2'd0
|Данных                    | 2'd1
|Состояния                 | 2'd2
|Адреса устройства         | 2'd3
|===

<<<
[[state-machine]]
== Конечный автомат
image::image_ApbCommunicator_SM.png[title="Конечный автомат модуля SlTransmitter", align="center"]

<<<
