= ApbCommunicator
:Date:      31.11.2017
:Revision:  0.5
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[communicator-main-description]]
== Описание
Модуль используется в проекте приемопередатчика SL канала для обработки APB транзакций, управления приемниками и передатчиками, соединением выходных портов с приемниками и передатчиками и коммутацией прерываний.


[[communicator-params]]
== Параметры Конфигурации
[cols="2*^1,1*<2", halign="left", width=99%]
|===
|Название      |Значение по умолчанию |Описание
|CC            |2                     |Channel count -- количество каналов в устройстве. _Допустимые значения: значения от 1 до 4_
|===

[[communicator-top-level-description]]
== Описание верхнего уровня
.Порты цифрового модуля SlReciever
[cols="3*^1,1*^2,1*<3", halign="left", width=99%]
|===
|Название      |Тип   |Разрядность |Значение после сброса |Описание
|_rst_n_       |In    |1           | -                    |Асинхронный общий сигнал сброса
|_clk_         |In    |1           | -                    |Сигнал тактовой частоты
5+|APB-связанные сигналы
|_prst_n_      |In    |1           | -                    |Асинхронный сигнал сброса
|_pclk_        |In    |1           | -                    |Cигнал тактовой частоты
|_psel_        |In    |1           | -                    |Cигнал выбора устройства
|_penable_     |In    |1           | -                    |Cигнал разрешения работы
|_pwrite_      |In    |1           | -                    |Cигнал выбора чтения или записи
|_paddr_       |In    |16          | -                    |Шина адреса
|_pwdata_      |In    |32          | -                    |Шина записи данных
|_prdata_      |Out   |32          |h0000_0000            |Шина чтения данных
|_pready_      |Out   |1           |b0                    |Cигнал готовности к чтению или записи данных
5+|Сигналы приемников и передатчиков
|_from_irq_      |in     |CC&#42;2                 | -                    |Сигналы прерываний приемников и передатчиков
|_from_D_out_    |in     |CC&#42;2&#42;32          | -                    |Шина для записи данных в приемники и передатчики
|_to_D_in_       |out    |32                       |h0000_0000            |Шина чтения данных из приемников и передатчиков
|_to_addr_       |out    |CC&#42;2                 |b0                    |Адресные входы приемников и передатчиков
|_to_wr_en_      |out    |CC&#42;2                 |b0                    |Сигналы разрешения записи приемников и передатчиков
5+|Сигналы мультиплексоров
|_channel_mode_  |out    |CC                       |b0                    |Сигналы управления мультиплексорами
|_loop_          |out    |CC/2                     |b0                    |Сигналы управления мультиплексорами
5+|Сигналы прерываний и програмного сброса
|_irq_in_        |in     |CC&#42;2                 |-                     |Сигналы прерываний
устройств
|_irq_out_       |out    |1                        |b0                    |Общий сигнал запроса на прерывание блока
|_soft_reset_    |out    |1                        |b0                    |Общий сигнал программного сброса для подключенных устройств
|===

[[communicator-programm-model]]
== Программная модель
.Пользователю для работы доступно несколько регистров:
Пользователю для работы доступны:

* Регистр управления (*control_r*)


=== Регистр управления
[[communicator_control_table]]
.Назначение разрядов регистра управления (*control_r*)
[cols="1*^2,1*^2,13*^1", width=99%]
|===
|Bit        |15-13      |12 |11 |10 |9   |8 | 7  |6  |5  |4 |3 |2 |1 |0
|Name       |-        4+|IRQC          2+|-    2+|LOOP 4+|MODE       |SR
|Mode       |R        4+|R             2+|R    2+|R/W  4+|R/W        |R/W
|Initial    |0          |0  |0  |0  |0   |0 |0 2+|0      |0 |0 |0 |0 |0
|===


.Описание разрядов регистра управления(*control_r*)
. *SR* -- Общий сброс всех модулей
. *MODE*  -- Выбор режима работы каналов.
. *LOOP*  -- Включение и отключение петель.
. *IRQC*  -- Номер устройства требующего обработки прерывания

Номер разряда поля MODE соответствует номеру канала. При СС = 1, используется только разряд *MODE0*, при СС = 2, используются разряды *MODE0* и *MODE1* и так далее. Неиспользуемые поля зарезервированы.

.Соответствие разрядов поля <<tr_conf_table,*MODE*>> и режимов работы каналов
[cols="2*^,1*<2", width=99%]
|===
|Разряд поля *MODE*        |Значение |Режим работы канала
.2+|*MODE0*                |0        |Передатчик
                           |1     1+<|Приемник
.2+|*MODE1*                |0        |Передатчик
                           |1     1+<|Приемник
.2+|*MODE2*                |0        |Передатчик
                           |1     1+<|Приемник
.2+|*MODE3*                |0        |Передатчик
                           |1     1+<|Приемник
|===
При СС = 1, используется только разряд *MODE0*, при СС = 2, используются разряды *MODE0* и *MODE1* и так далее. Неиспользуемые поля зарезервированы.

.Соответствие разряда <<communicator_control_table,*LOOP0*>> и наличия петли между 0 и 1 каналом
[cols="3*^", width=99%]
|===
|Значение разряда *LOOP0*  |Значение выражения  (*MODE0*==*MODE1*)  | Наличие петли между каналами 0 и 1
|0                         |0                                       |нет
|0                         |1                                       |нет
|1                         |0                                       |нет
|1                         |1                                       |да
|===
Возможность создания петли между каналами 0 и 1 предусмотрена только при значениях CC > 2.
Если CC = 1, поля *LOOP0* и *LOOP1* зарезервированы.

.Соответствие разряда <<communicator_control_table,*LOOP1*>> и наличия петли между 2 и 3 каналом
[cols="3*^", width=99%]
|===
|Значение разряда *LOOP1*  |Значение выражения  (*MODE2*==*MODE3*)  | Наличие петли между каналами 2 и 3
|0                         |0                                       |нет
|0                         |1                                       |нет
|1                         |0                                       |нет
|1                         |1                                       |да
|===
Возможность создания петли между каналами 2 и 3 предусмотрена только при значении CC = 4.
Если CC < 4, поле *LOOP1* зарезервировано.

// .Соответствие разрядов поля <<communicator_control_table,*IRQC*>> и устройств требующих обработки прерывания
// [cols="2*^,1*<2", width=99%]
// |===
// |Разряд поля *IRQC*        |Значение | Режим
// |*IRQC0*                   |1        | Передатчик канала 0 сформировал запрос на прерывание
// |*IRQC1*                   |1        | Приемник канала 0 сформировал запрос на прерывание
// |*IRQC2*                   |1        | Передатчик канала 1 сформировал запрос на прерывание
// |*IRQC3*                   |1        | Приемник канала 1 сформировал запрос на прерывание
// |*IRQC4*                   |1        | Передатчик канала 2 сформировал запрос на прерывание
// |*IRQC5*                   |1        | Приемник канала 2 сформировал запрос на прерывание
// |*IRQC6*                   |1        | Передатчик канала 3 сформировал запрос на прерывание
// |*IRQC7*                   |1        | Приемник канала 3 сформировал запрос на прерывание
// |===
// При СС = 1, используется только разряды *IRQC0* и *IRQC1*, при СС = 2, используются разряды *IRQC0*, *IRQC1*, *IRQC2*, *IRQC3* и так далее. Неиспользуемые разряды зарезервированы.

== Работа с программной моделью

Запись и чтение регистра управления происходит по шине Apb.
Также модуль обеспечивает чтение и запись регистров всех подключенных к нему приемников и передатчиков.

.Адресное пространство модуля ApbCommunicator
[cols="4*^", width=99%]
|===
|Смещение относительно BASE_ADDRESS  |Устройство |Регистр |Номер канала
|0  |ApbCommunicator   |Управления   | -
|1  |Передатчик        |Служебный .4+| 0
|2  |Передатчик        |Данных
|3  |Приемник          |Служебный
|4  |Приемник          |Данных
|5  |Передатчик        |Служебный .4+| 1
|6  |Передатчик        |Данных
|7  |Приемник          |Служебный
|8  |Приемник          |Данных
|9  |Передатчик        |Служебный .4+| 2
|10 |Передатчик        |Данных
|11 |Приемник          |Служебный
|12 |Приемник          |Данных
|13 |Передатчик        |Служебный .4+| 3
|14 |Передатчик        |Данных
|15 |Приемник          |Служебный
|16 |Приемник          |Данных
|===

Если параметр CC не равен 4, адреса отсутствующих каналов остаются не занятыми.

=== Работа с прерываниями

В поле IRQC содержится номер устройства первым запросившего обработку прерывания. После того, как прерывание этого устройства будет обработано, в IRQC будет помещен адрес следующего устройства, запрашивающего обработку прерывания.

=== Выключение модуля
Чтобы выключить модуль необходимо записать 1 в разряд *SR* регистра управления.

Отправка и прием всех сообщений устройствами прекращается. Сбрасываются все поля регистров устройств отвечающие за состояние.

== Принцип работы

В ходе работы, обрабатывает транзакции APB шины и на основе транзакций управляет приемниками и передатчиками.


== Алгоритм Работы

=== Реализация чтения и записи регистров
image::image_ApbCommunicator_SM.png[title="Конечный автомат модуля ApbCommunicator", align="center"]

В устройстве используются следующие вспомогательные сигналы и регистры:
[cols="3*^1,1*^2,1*<3", halign="left", width=99%]
|===
|Название           |Тип     |Разрядность  |Значение после сброса  |Описание
|_loc_addr_         |сигнал  |16           |h0000 - BASE_ADDRESS | Сигнал внутреннего адреса устройства
|_loc_addr_is_corr_ |сигнал  |1            |b0 |Сигнал проверки _loc_addr_ на соответствие содержимому таблицы <<comm_addr_table,адресного пространства>>.
|===

Если значение _loc_addr_ соответствует одному из описанных в таблице  <<comm_addr_table,адресного пространства>>, а также вход _psel_ выставлен в единицу, модуль начинает транзакцию, и в зависимости от значения _pwrite_ конечный автомат  переходит из состояния IDLE в состояние READ или WRITE.

В состоянии READ на порт _prdata_ в зависимости от значения _loc_addr_ выставляется либо содержимое регистра управления, либо содержимое части шины _from_D_out_[32*(_loc_addr_):(32*(_loc_addr_-1)+1)].  На выход _pready_ выставляется 1.  Из состояния READ модуль переходит в состояние READEND.

В состоянии READEND на выход выход _pready_ выставляется 0. Модуль переходит в состояние IDLE.

В состоянии WRITE на yа выход _pready_ выставляется 1.  Из состояния WRITE модуль переходит в состояние WRITEEND.

В состоянии WRITEEND на выход выход _pready_ выставляется 0. Если _penable_ установлен в 1 и если _loc_addr_ соответствует одному из регистров, на выход _to_D_in_ устанавливается содержимое шины _pwdata_ а на разряд порта _to_wr_en_ соответствующий адресу
устанавливается 1.

В состоянии IDLE все выходы _to_wr_en_ устанавливаются в 0.

=== Работа поля *IRQC*

Работа поля *IRQC* организована при помощи буфера глубиной N и шириной CC*2. Когда один из разрядов _irq_in_ переключается в единицу и буфер не полон, в буфер записывается содержимое порта _irq_in_. Когда всем разрядам установленным в единицы в буфере соотвествует нули в разрядах _irq_in_ из буфера считывается значение.

Значение *IRQC* это номер разряда буфера, значение которого равно 1 и значение разряда того же номера входа _irq_in_ тоже равно 1. Если этому условию соотвествует несколько разрядов, то выбирается номер того разряда, приоритет которого больше. Большим приоритетом имеют разряды относящиеся к приемникам чем разряды относящиеся к передатчиков. Среди разрядов приемников больше приоритет у разряда, относящегося к каналу с меньшим номером.
