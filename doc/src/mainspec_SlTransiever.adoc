= Микроархитектурная спецификация SlTransiever
===========
:Date:      25.01.2018
:Revision:  0.3
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog многоканального приемопередатчика SL-канала.

[[module-function]]
=== Назначение

.Тип блока
Переферийный

.Функция
Сложно функциональный блок SlTranciever - это блок, посредством которого осуществляется
обмен данными с внешними устройствами в соответствии с протоколом обмена

[[module-parameters]]
=== Параметры конфигурации

Параметры конфигурации СФ-блока SlTransiever приведены в таблице.
.Описание параметров блока SlTranciever
[cols="3*^", width=99%, options=header]
|===
|Имя           |Значение по умолчанию |Описание
|CHANNEL_COUNT |1                     | Количество каналов. На каждый канал создается по одному приемнику и передатчику
|===

[[functional-description]]
== Функциональное описание

[[structure]]
=== Структурная схема

Структурная схема СФ-блока SlTransiever приведена на рисунке:

image::SlTrancieverStructure.png[title="Общая схема СФ-блока SlTransiever", align="center"]

Элементы, которые входят в СФ-блок SlTranciever и представлены на структурной схеме, перечислены
в таблице:

.Модули, входящие в СФ-блок SlTransiever
[cols="2*^", width=99%, options=header]
|===
|Название               |Функция
|SlTransiever           |Верхний уровень СФ-блока. Выполняет функции отправки и приема сообщий по нескольким Sl каналам
|SlTransmitter          |Передатчик. Отправляет Sl сообщения
|SlReciever             |Приемник. Принимает Sl сообщения
|Router                 |Управляет инстансами приемников и передатчиков
|AsyncFifo              |Асинхронный буфер, используются для передачи информации из одного клокового домена в другой
|ApbCommunicator        |Обрабатывает Apb транзакции
|===

[[work-description]]
=== Описание работы

SlTranciever предназначен для взаимодействия с переферийными устройствами,
подключенными по Sl интерфейсам. Для этого инстанцируется блок с указанным количеством каналов.
 На каждый канал приходится по одному приемнику и передатчику.

Каждый инстанс приемника и передатчика имеет свой адрес. Одновременно пользователь может
 управлять только одним устройством. Управление устройствами осуществляется записью и чтением регистров по апб шине.

[[work-write-transaction]]
==== Транзакции записи

Возможна запись в следующие регистры:

.Регистры доступные для записи
* Регистр адреса устройства
* Регистр конфигурации выбранного устройства
* Регистр данных выбранного устройства

При транзакции записи в один из выбранных регистров модуль ApbCommunicator записывает
соответствующее сообщение в асинхронный буфер.
Модуль Router, в зависимости от содержимого этого сообщения,
 либо записывает новый адрес управляемого устройства,
либо передает содержимое сообщения в управляемое устройство.
Управляемое устройство задается содержимым регистра адреса устройства внутри модуля Router.

[[work-read-transaction]]
==== Транзакции чтения
Модуль Router считывает значения регистров выбранного устройства при смене адреса управляемого устройства, или же при их изменении.
Сообщения с соотвестующими данными он помещает в обратный асинхронный буфер.

Модуль ApbCommunicator считывает эти сообщения и помещает их в соотвествующие
регистры, дублирующие регистры управляемого устройства. Содержимое регистров ApbCommunicator по запросу помещает на шину Apb.

[[clk-and-reset]]
=== Синхронизация и сброс
СФ-блок спроектирован для работы в двух доменах синхронизации: системная частота clk и частота Apb шины pclk. Частоты clk и pclk примерно равны.

В каждом домене синхронизации необходимо наличие своего сигнала сброса с активным низким
уровнем, выставляемым асинхронно и снимаемым по фронту сигнала синхронизации.


[[low-level-modules]]
== Подмодули
:leveloffset: 2


include::spec_ApbCommunicator.adoc[]
include::spec_Router.adoc[]
include::spec_SlTransmitter.adoc[]
include::spec_SlReciever.adoc[]
// Return to normal title levels.
:leveloffset: 0

[[top-level-description]]
=== Описание верхнего уровня

[[input-signals]]
==== Входные сигналы
.Общие сигналы
* rst_n - асинхронный общий сигнал сброса
* clk - сигнал тактовой частоты


.APB-связанные сигналы
* pclk - сигнал тактовой частоты
* preset_n - асинхронный сигнал сброса
* [15:0] paddr - асинхронная шина адреса
* psel - асинхронный сигнал выбора устройства
* penable - асинхронный сигнал разрешения работы
* pwrite - асинхронный сигнал выбора чтения или записи
* [31:0] pwdata - асинхронная шина данных

.SL-связанные сигналы
* SL0_in - асинхронный сигнал линии нулей
* SL1_in - асинхронный сигнал линии единиц

[[output-signals]]
==== Выходные сигналы
.APB-связанные сигналы
* [31:0] prdata - шина данных
* pready - асинхронный сигнал готовности к приему или передаче данных

.SL-связанные сигналы
* SL0_out - синхронный сигнал линии нулей
* SL1_out - синхронный сигнал линии единиц

[[inout-signals]]
==== Двунаправленные сигналы
Отсутствуют.

[[signals-frequency-realtions]]
==== Тактирование сигналов

.Указание на источник тактирования входных и выходных сигналов
[cols="3*^", width=99%, options=header]
|===
|Сигнал                 |Направленность |Клоковый домен
|rst_n                  |in             | async
|SL0_in                 |in             | async
|SL1_in                 |in             | async
|preset_n               |in             | async
|[15:0]paddr            |in             | pclk
|psel                   |in             | pclk
|penable                |in             | pclk
|pwrite                 |in             | pclk
|[31:0]pwdata           |in             | pclk
|[31:0]prdata           |out            | pclk
|pready                 |out            | pclk
|SL0_out                |out            | clk
|SL1_out                |out            | clk
|===


[[programm-model]]
=== Программная модель
Пользователю для работы доступно несколько регистров:

. Конфигурационный
. Состояния
. Данных
. Номера управляемого устройства (приемника или передатчика)

==== Регистр конфигурации
Назначение битов регистра конфигурации различается в зависимости от
того является или управляемое устройство приемником или передатчиком (значение первого бита регистра адреса устройства)
.Назначение разрядов регистра config_r в режиме приемника
[cols="16*^", width=99%]
|===
|0     |1 |2 |3 |4 |5 |6    |7    |8    |9    |10   |11   |12   |13   |14    |15
|PCE 6+|BC[5:0]             |MODE |IRQM |Res* |Res* |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра config_r в режиме приемника
. PCE - parity check enable, разрешение контроля четности(PCE = 1), или запрещение(PCE = 0)
. BC - bit count, количество бит в слове
. MODE - выбор режима работы модуля в качестве приемника(MODE = 0), или передатчика(MODE = 1)
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля

.Назначение разрядов регистра config_r в режиме передатчика
[cols="16*^", width=99%]
|===
   |0     |1 |2 |3 |4 |5  |6       |7    |8    |9     |10   |11   |12   |13   |14    |15
 6+|BC[6:0]               |IRQM  3+|FQM[9:7]          |Res* |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра config_r в режиме передатчика
. BC - bit count, количество бит в слове
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля
. FQM - frequency mode, соответствие частот описано в таблице ниже

При ошибке указания количества бит в слове (нечетное или меньше восьми) попытка смены конфигурации будет игнорирована.

.Связь значения FQM и частоты работы передатчика
[cols="2*^", width=99%]
|===
|Значение FQM в десятичной системе     | Частота, Мгц
|1                                     |8
|2                                     |4
|3                                     |2
|4                                     |1
|5                                     |0.5
|>5                                    |0.5
|===


==== Регистр состояния
Назначение разрядов первого байта разрядов регистра состояния зависят от
режима работы приемопередатчика.
Второй байт регистров состояния содержит биты отвечающие за состояние приемопередатчика в целом

.Назначение разрядов регистра status_r в режиме приемника
[cols="16*^", width=99%]
|===
|0     |1   |2    |3   |4   |5   |6    |7    |8    |9    |10   |11   |12   |13   |14   |15
|WLC   |WRP |Res* |WRF |PEF |LEF |Res* |Res* |CBF  |CBE  |Res* |Res* |Res* |Res* |Res* |Res*
|===

.Описание разрядов регистра status_r в режиме приемника
. WLC - word length check, результат проверки длины полученного слова на равенство значению BC регистра config_r, WLC = 1, если значения не равны
. WRP - word receiving process, флаг идущего процесса приема слова по SL-каналу
. Res* - Зарезервированно
. WRF - word received flag, флаг успешно завершенного приема слова
. PEF - parity error flag, флаг наличия(PEF = 1) ошибки четности принятого слова
. LEF - level error on line flag, флаг наличия ошибки уровня напряжения на линии SL-канала
. CBF - control buffer is full буфер, куда записываются управляющие команды полон
. CBE - control buffer is empty буфер, куда записываются управляющие команды пуст

.Назначение разрядов регистра status_r в режиме передатчика
[cols="16*^", width=99%]
|===
|0     |1     |2    |3    |4    |5    |6    |7    |8    |9    |10   |11   |12   |13   |14   |15
|SIP   |Res*  |Res* |Res* |Res* |Res* |Res* |Res* |CBF  |SBE  |Res* |Res* |Res* |Res* |Res* |Res*
|===
.Описание разрядов регистра status_r в режиме передатчика
. SIP - send in process - передатчик в данный момент занят отправкой сообщения
. CBF - control buffer is full буфер, куда записываются управляющие команды полон
. CBE - control buffer is empty, куда записываются управляющие команды пуст

Описание особенностей работы управляющего буфера будет объяснено далее

==== Регистр данных
data_r[31:0] - регистр данных в котором находится последнее успешно принятое сообщение.
В режиме передатчика при транзакции записи в регистр записываемое слово принимается к отправке,
значение регистра не меняется.

В режиме приемника при тразакции чтения вы получите последнее прнятое приемником сообщение.
Транзакция записи в режиме приемника будет игнорирована.

==== Регистр адреса устройства
Регистр адреса устройства. Количество устройств определяется количеством каналов (на каждый канал приходится один приемник и один передатчик). Приемники имеют нечетные адреса, передатчики четные. При попытке записать некорректное значение, попытка будет игнорирована.

=== Конечный автомат

image::image_SlTransmitter_SM.png[title="Конечный автомат транзакций записи в регистры", align="center"]
