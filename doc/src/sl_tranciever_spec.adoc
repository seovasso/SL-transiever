= Спецификация моста APB - Rx,Tx SL-канала [DRAFT]
===========
:Date:      09.01.2018
:Revision:  0.1
:toc:       right
:icons:     font
:source-highlighter: rouge
:table-caption:     Таблица
:listing-caption:   Код
:chapter-label:     Глава
:toc-title:         Оглавление
:version-label:     Версия
:figure-caption:    Рисунок
:imagesdir:         ./../img/

[[main-description]]
== Описание
Данный проект подразумевает реализацию RTL-описания на языке Verilog одноканального приемопередатчика SL-канала.

[[sl-channel-review]]
== Описание SL-канала
SL - канал - последовательный однонаправленный канал обмена данными, разработанный для внутриплатного и межплатного обмена информацией. Обмен данными типа "точка-с-точкой". Канал состоит из двух линий: линии единиц и линии нулей. Пассивный уровень на линиях - единица. В случае передачи данных каждый разряд кодируется отрицательным импульсом на соответствующей линии. Информация передается словами произвольной разрядности младшими разрядами вперед. Предпоследний разряд - четность. Передатчик вычисляет четность таким образом, чтобы количество импульсов на линии единиц с учетом разряда четности было нечетным, а на линии нулей - четным. Приемник контролирует четность индивидуально по каждой линии. Последним импульсом является синхроимпульс, представляющий собой отрицательные импульсы по обоим линиям одновременно. Синхроимпульс означает, что передача закончена. Не допускается перекрытия информационных импульсов во время передачи.

image::SL.png[title="Временная диаграмма SL-канала", align="center"]

Типичная рабочая частота передатчика, спроектированного в синхронном стиле,
составляет от 500кГц до 1МГц. Пауза между информационными битами равна длительности
 отрицательного импульса.

[[top-level-description]]
== Описание верхнего уровня

[[input-signals]]
=== Входные сигналы
.Общие сигналы
* rst_n - асинхронный общий сигнал сброса
* clk - сигнал тактовой частоты


.APB-связанные сигналы
* pclk - сигнал тактовой частоты
* preset_n - асинхронный сигнал сброса
* [15:0] paddr - асинхронная шина адреса
* psel - асинхронный сигнал выбора устройства
* penable - асинхронный сигнал разрешения работы
* pwrite - асинхронный сигнал выбора чтения или записи
* [31:0] pwdata - асинхронная шина данных

.SL-связанные сигналы
* SL0_in - асинхронный сигнал линии нулей
* SL1_in - асинхронный сигнал линии единиц

[[output-signals]]
=== Выходные сигналы
.APB-связанные сигналы
* [31:0] prdata - шина данных
* pready - асинхронный сигнал готовности к приему или передче данных

.SL-связанные сигналы
* SL0_out - синхронный сигнал линии нулей
* SL1_out - синхронный сигнал линии единиц

[[inout-signals]]
=== Двунаправленные сигналы
Отсутствуют.

[[signals-frequency-realtions]]
=== Тактирование сигналов

.Указание на источник тактирования входных и выходных сигналов
[cols="3*^", width=99%, options=header]
|===
|Сигнал                 |Направленность |Клоковый домен
|rst_n                  |in             | async
|SL0_in                 |in             | async
|SL1_in                 |in             | async
|preset_n               |in             | async
|[15:0]paddr            |in             | pclk
|psel                   |in             | pclk
|penable                |in             | pclk
|pwrite                 |in             | pclk
|[31:0]pwdata           |in             | pclk
|[31:0]prdata           |out            | pclk
|pready                 |out            | pclk
|SL0_out                |out            | clk
|SL1_out                |out            | clk
|===


[[programm-model]]
== Программная модель
Пользователю для работы доступно несколько регистров:

. Конфигурационный
. Статусный
. Данных
. Номера канала

=== Регистр конфигурации
Назначение битов регистра конфигурации различается в зависимости от
того сконфигурирован ли приемопередатчик как приемник или как передатчик (значение регистра канала)
.Назначение разрядов регистра config_r в режиме приемника
[cols="16*^", width=99%]
|===
|0     |1 |2 |3 |4 |5 |6    |7    |8    |9    |10   |11   |12   |13   |14    |15
|PCE 6+|BC[6:0]             |MODE |IRQM |Res* |Res* |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра config_r в режиме приемника
. PCE - parity check enable, разрешение контроля четности(PCE = 1), или запрещение(PCE = 0)
. BC - bit count, количество бит в слове
. MODE - выбор режима работы модуля в качестве применика(MODE = 0), или передатчика(MODE = 1)
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля

.Назначение разрядов регистра config_r в режиме передатчика
[cols="16*^", width=99%]
|===
   |0     |1 |2 |3 |4 |5  |6       |7    |8    |9     |10   |11   |12   |13   |14    |15
 6+|BC[6:0]               |IRQM  3+|FQM[9:7]          |Res* |Res* |Res* |Res* |Res*  |Res*
|===

.Описание разрядов регистра config_r в режиме передатчика
. BC - bit count, количество бит в слове
. IRQM - interrupt request mode, разрешение(IRQM = 1) или запрещение(IRQM = 0) работы прерываний модуля
. FQM - frequency mode, соответствие частот описано в таблице ниже

При ошибке указания количества бит в слове (нечетное или меньше восьми) попытка смены конфигурации будет игнорирована.

.Связь значения FQM и частоты работы передатчика
[cols="2*^", width=99%]
|===
|Значение FQM в десятичной системе     | Частота, Мгц
|1                                     |8
|2                                     |4
|3                                     |2
|4                                     |1
|5                                     |0.5
|>5                                    |0.5
|===


=== Регистр состояния
Назначение разрядов первого байта разрядов регистра состояния зависят от
режима работы приемопередатчика.
Второй байт регистров состояния содержит биты отвечающие за состояние приемопередатчика в целом

.Назначение разрядов регистра status_r в режиме приемника
[cols="16*^", width=99%]
|===
|0     |1   |2    |3   |4   |5   |6    |7    |8    |9    |10   |11   |12   |13   |14   |15
|WLC   |WRP |Res* |WRF |PEF |LEF |Res* |Res* |CBF  |CBE  |Res* |Res* |Res* |Res* |Res* |Res*
|===

.Описание разрядов регистра status_r в режиме приемника
. WLC - word length check, результат проверки длины полученного слова на равенство значению BC регистра config_r, WLC = 1, если значения не равны
. WRP - word receiving process, флаг идущего процесса приема слова по SL-каналу
. Res* - Зарезервированно
. WRF - word received flag, флаг успешно завершенного приема слова
. PEF - parity error flag, флаг наличия(PEF = 1) ошибки четности принятого слова
. LEF - level error on line flag, флаг наличия ошибки уровня напряжения на линии SL-канала
. CBF - control buffer is full буфер, куда записываются управляющие команды полон
. CBE - control buffer is empty буфер, куда записываются управляющие команды пуст

.Назначение разрядов регистра status_r в режиме передатчика
[cols="16*^", width=99%]
|===
|0     |1     |2    |3    |4    |5    |6    |7    |8    |9    |10   |11   |12   |13   |14   |15
|SIP   |Res*  |Res* |Res* |Res* |Res* |Res* |Res* |CBF  |SBE  |Res* |Res* |Res* |Res* |Res* |Res*
|===
.Описание разрядов регистра status_r в режиме передатчика
. SIP - send in process - передатчик в данный момент занят отправкой сообщения
. CBF - control buffer is full буфер, куда записываются управляющие команды полон
. CBE - control buffer is empty, куда записываются управляющие команды пуст

Описание особенностей работы управляющего буфера будет объяснено далее

=== Регистр данных
data_r[31:0] - регистр данных в котором находится поледнее упешно принятое сообщение.
В режиме передатчика при транзакции записи в регистр записываемое слово принимается к отправке,
значение регистра не меняется.

В режиме приемника при тразакции чтения вы получите последнее прнятое приемником сообщение.
Транзакция записи в режиме приемника будет игнорирована.

=== Регистр канала
Регистр канала задает режим работы. При поытке записать некорректное значение, все биты кроме первого будут игнорированы.

.Значения регистра номера канала
* "0"  - модуль сконфигурирован для работы как передатчик
* "1"  - модуль сконифгурирован для работы как приемник
